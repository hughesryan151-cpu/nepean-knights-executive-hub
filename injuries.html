<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Injuries â€“ Nepean Knights</title>
<link rel="stylesheet" href="style.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
/* Same styling as before */
</style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center;">
    <img src="nepean-knights-logo.png" alt="Logo" class="logo">
    <img src="knights-banner-updated.png" alt="Banner" class="banner">
  </div>
  <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
</header>

<main>
  <div class="card">
    <h2>Player Injuries</h2>
    <button onclick="showForm()"><i class="fas fa-plus"></i> Report New Injury</button>

    <section id="injuryForm" style="display:none; margin-top:20px;">
      <input type="hidden" id="injuryId">
      <input type="text" id="playerName" placeholder="Player Name">
      <input type="text" id="teamName" placeholder="Team">
      <input type="date" id="injuryDate">
      <textarea id="injuryDescription" placeholder="Description of Injury"></textarea>
      <textarea id="actionsTaken" placeholder="Actions Taken"></textarea>

      <label><input type="checkbox" id="headInjury"> Head Injury / Concussion</label>

      <h4>Return to Play</h4>
      <input type="date" id="returnDate" placeholder="Return Date">
      <input type="time" id="returnTime" placeholder="Return Time">
      <textarea id="doctorNotes" placeholder="Doctor Notes"></textarea>

      <label>Attach Document (PDF/Image)</label>
      <input type="file" id="injuryFile">

      <button onclick="saveInjury()"><i class="fas fa-save"></i> Save Injury</button>
    </section>

    <div class="summary-cards">
      <div class="summary-card" id="totalInjuriesCard"><h3>Total Injuries</h3><p>0</p></div>
      <div class="summary-card" id="headInjuriesCard"><h3>Head Injuries</h3><p>0</p></div>
      <div class="summary-card" id="clearedPlayersCard"><h3>Cleared Players</h3><p>0</p></div>
    </div>

    <div class="filter-section">
      <label>Filter Status:</label>
      <select id="statusFilter" onchange="loadInjuries()">
        <option value="all">All</option>
        <option value="injured">Injured</option>
        <option value="cleared">Cleared</option>
        <option value="headInjury">Head Injuries</option>
      </select>
    </div>

    <h3>Injury Dashboard</h3>
    <table>
      <thead>
        <tr>
          <th>Player</th><th>Team</th><th>Date</th><th>Description</th><th>Head Injury</th>
          <th>Actions Taken</th><th>Return Date/Time</th><th>Doctor Notes</th><th>File</th>
          <th>Status</th><th>Admin Override</th><th>Edit</th><th>Reported</th>
        </tr>
      </thead>
      <tbody id="injuryList"></tbody>
    </table>
  </div>

  <button onclick="window.location.href='dashboard.html'" style="margin:20px auto; display:block;">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
  </button>
</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
  authDomain: "nepean-knights-executive-hub.firebaseapp.com",
  projectId: "nepean-knights-executive-hub",
  storageBucket: "nepean-knights-executive-hub.firebasestorage.app",
  messagingSenderId: "103399385512",
  appId: "1:103399385512:web:bbd8ac65b5c8be5332159d"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

auth.onAuthStateChanged(user => { if(!user) window.location.href="index.html"; });
function logout(){ auth.signOut().then(()=> window.location.href="index.html"); }
function showForm(){ document.getElementById('injuryForm').style.display='block'; }

async function uploadFile(file, playerName){
  if(!file) return null;
  const storageRef = storage.ref(`injury_docs/${playerName}_${Date.now()}_${file.name}`);
  const snapshot = await storageRef.put(file);
  return await snapshot.ref.getDownloadURL();
}

async function saveInjury(){
  const playerName = document.getElementById('playerName').value.trim();
  const teamName = document.getElementById('teamName').value.trim();
  const date = document.getElementById('injuryDate').value;
  const description = document.getElementById('injuryDescription').value.trim();
  const actions = document.getElementById('actionsTaken').value.trim();
  const headInjury = document.getElementById('headInjury').checked;
  const returnDate = document.getElementById('returnDate').value;
  const returnTime = document.getElementById('returnTime').value;
  const doctorNotes = document.getElementById('doctorNotes').value.trim();
  const file = document.getElementById('injuryFile').files[0];
  const injuryId = document.getElementById('injuryId').value;

  if(!playerName || !teamName || !date || !description){
    alert('Please fill all required fields'); return;
  }

  if(headInjury && !doctorNotes && returnDate && returnTime){
    alert('For head injuries, doctor notes are required before return to play.'); return;
  }

  const fileUrl = await uploadFile(file, playerName);

  // Determine resolved automatically
  let resolved = false;
  if(returnDate && returnTime){
    const returnDT = new Date(returnDate+'T'+returnTime);
    if(returnDT <= new Date()) resolved = true;
  }

  const injuryData = {
    playerName, teamName, date, description, actions,
    headInjury, returnDate, returnTime, doctorNotes,
    statusOverride: '', resolved,
    fileUrl: fileUrl || null,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  if(injuryId){
    await db.collection('injuries').doc(injuryId).update(injuryData);
    alert('Injury updated!');
  } else {
    await db.collection('injuries').add(injuryData);
    alert('Injury report saved!');
  }

  document.getElementById('injuryForm').reset();
  document.getElementById('injuryId').value = '';
  document.getElementById('injuryForm').style.display = 'none';
  loadInjuries();
}

function editInjury(id){
  db.collection('injuries').doc(id).get().then(doc=>{
    const d = doc.data();
    document.getElementById('injuryId').value = id;
    document.getElementById('playerName').value = d.playerName;
    document.getElementById('teamName').value = d.teamName;
    document.getElementById('injuryDate').value = d.date;
    document.getElementById('injuryDescription').value = d.description;
    document.getElementById('actionsTaken').value = d.actions;
    document.getElementById('headInjury').checked = d.headInjury || false;
    document.getElementById('returnDate').value = d.returnDate || '';
    document.getElementById('returnTime').value = d.returnTime || '';
    document.getElementById('doctorNotes').value = d.doctorNotes || '';
    document.getElementById('injuryForm').style.display='block';
  });
}

function overrideStatus(docId, newStatus){
  const resolved = newStatus === 'Cleared';
  db.collection('injuries').doc(docId).update({statusOverride: newStatus, resolved}).then(()=> loadInjuries());
}

function loadInjuries(){
  const tbody = document.getElementById('injuryList');
  const filter = document.getElementById('statusFilter').value;
  tbody.innerHTML='';

  let totalInjuries = 0;
  let headInjuries = 0;
  let clearedPlayers = 0;

  db.collection('injuries').orderBy('timestamp','desc').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const d = doc.data();
      const returnDT = d.returnDate && d.returnTime ? new Date(d.returnDate+'T'+d.returnTime) : null;
      let statusClass = 'status-injured';
      let statusText = 'Injured';

      if(d.statusOverride === 'Cleared' || (returnDT && returnDT <= new Date())){
        statusClass = 'status-cleared';
        statusText = d.statusOverride === 'Cleared' ? 'Cleared (Admin)' : 'Cleared';
        if(!d.resolved) db.collection('injuries').doc(doc.id).update({resolved:true});
      } else {
        if(d.resolved) db.collection('injuries').doc(doc.id).update({resolved:false});
      }

      totalInjuries++;
      if(d.headInjury) headInjuries++;
      if(statusText.toLowerCase().includes('cleared')) clearedPlayers++;

      if(filter === 'injured' && !statusText.toLowerCase().includes('injured')) return;
      if(filter === 'cleared' && !statusText.toLowerCase().includes('cleared')) return;
      if(filter === 'headInjury' && !d.headInjury) return;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.playerName}</td><td>${d.teamName}</td><td>${d.date}</td><td>${d.description}</td>
        <td>${d.headInjury?'Yes':'No'}</td><td>${d.actions}</td>
        <td>${d.returnDate&&d.returnTime?d.returnDate+' '+d.returnTime:''}</td>
        <td>${d.doctorNotes||''}</td>
        <td>${d.fileUrl?`<a href="${d.fileUrl}" target="_blank">View</a>`:''}</td>
        <td class="${statusClass}">${statusText}</td>
        <td>
          <select onchange="overrideStatus('${doc.id}', this.value)">
            <option value="">-- Override --</option>
            <option value="Cleared">Cleared</option>
            <option value="Injured">Injured</option>
          </select>
        </td>
        <td><button onclick="editInjury('${doc.id}')"><i class="fas fa-edit"></i> Edit</button></td>
        <td>${d.timestamp?d.timestamp.toDate().toLocaleString():''}</td>
      `;
      tbody.appendChild(tr);
    });

    document.querySelector('#totalInjuriesCard p').innerText = totalInjuries;
    document.querySelector('#headInjuriesCard p').innerText = headInjuries;
    document.querySelector('#clearedPlayersCard p').innerText = clearedPlayers;
  });
}

loadInjuries();
</script>
</body>
</html>

