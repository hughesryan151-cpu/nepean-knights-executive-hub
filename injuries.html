<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Injuries â€“ Nepean Knights</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#FFD200,#E41F26);}
header{display:flex;justify-content:space-between;align-items:center;background:#E41F26;color:#FFD200;padding:10px 20px;}
header img{height:50px;}
header button{background:#FFD200;color:#000;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;font-weight:bold;}
header button:hover{opacity:0.9;}
main{padding:20px;}
.card{background:#FFF2CC;border-radius:10px;padding:20px;max-width:1250px;margin:20px auto;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
button{background:#FFD200;color:#000;padding:10px 15px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;transition:0.2s;}
button:hover{opacity:0.9;}
input,textarea,select{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
textarea{resize:vertical;}
h2{text-align:center;color:#E41F26;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ccc;padding:10px;text-align:left;}
th{background:#FFD200;color:#000;}
tr:nth-child(even){background:#fff8dc;}
.status-injured{background:#FF6B6B;color:#fff;font-weight:bold;text-align:center;}
.status-cleared{background:#4CAF50;color:#fff;font-weight:bold;text-align:center;}
.status-alert{background:#FF4500;color:#fff;font-weight:bold;text-align:center;animation:blink 1s infinite;}
@keyframes blink{0%{opacity:1;}50%{opacity:0.3;}100%{opacity:1;}}
.summary-cards{display:flex;justify-content:space-around;margin-top:20px;}
.summary-card{flex:1;background:#FFF8E1;padding:20px;margin:5px;border-radius:10px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.summary-card h3{margin:5px 0;color:#E41F26;}
.summary-card p{font-size:24px;font-weight:bold;}
#injuryForm{display:none;margin-top:20px;}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;">
    <img src="nepean-knights-logo.png" alt="Logo">
    <img src="knights-banner-updated.png" alt="Banner">
  </div>
  <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
</header>

<main>
  <div class="card">
    <h2>Player Injuries</h2>
    <button onclick="showForm()"><i class="fas fa-plus"></i> Report New Injury</button>

    <section id="injuryForm">
      <input type="hidden" id="injuryId">
      <input type="text" id="playerName" placeholder="Player Name">
      <input type="text" id="teamName" placeholder="Team">
      <input type="date" id="injuryDate">
      <textarea id="injuryDescription" placeholder="Description"></textarea>
      <textarea id="actionsTaken" placeholder="Actions Taken"></textarea>
      <label><input type="checkbox" id="headInjury"> Head Injury / Concussion</label>
      <h4>Return to Play</h4>
      <input type="date" id="returnDate">
      <input type="time" id="returnTime">
      <textarea id="doctorNotes" placeholder="Doctor Notes"></textarea>
      <label>Attach Document</label>
      <input type="file" id="injuryFile">
      <button onclick="saveInjury()"><i class="fas fa-save"></i> Save Injury</button>
    </section>

    <div class="summary-cards">
      <div class="summary-card" id="totalInjuriesCard"><h3>Total Injuries</h3><p>0</p></div>
      <div class="summary-card" id="headInjuriesCard"><h3>Head Injuries</h3><p>0</p></div>
      <div class="summary-card" id="clearedPlayersCard"><h3>Cleared Players</h3><p>0</p></div>
    </div>

    <div class="filter-section">
      <label>Filter Status:</label>
      <select id="statusFilter" onchange="loadInjuries()">
        <option value="all">All</option>
        <option value="injured">Injured</option>
        <option value="cleared">Cleared</option>
        <option value="headInjury">Head Injuries</option>
      </select>
    </div>

    <h3>Injury Dashboard</h3>
    <table>
      <thead>
        <tr>
          <th>Player</th><th>Team</th><th>Date</th><th>Description</th><th>Head Injury</th><th>Actions Taken</th><th>Return Date/Time</th><th>Doctor Notes</th><th>File</th><th>Status</th><th>Admin Override</th><th>Edit</th><th>Reported</th>
        </tr>
      </thead>
      <tbody id="injuryList"></tbody>
    </table>
  </div>

  <button onclick="window.location.href='dashboard.html'" style="margin:20px auto;display:block;"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
  authDomain: "nepean-knights-executive-hub.firebaseapp.com",
  projectId: "nepean-knights-executive-hub",
  storageBucket: "nepean-knights-executive-hub.firebasestorage.app",
  messagingSenderId: "103399385512",
  appId: "1:103399385512:web:bbd8ac65b5c8be5332159d"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

auth.onAuthStateChanged(user => {
  if(!user) window.location.href="index.html";
  else loadInjuries(); // Only load injuries after auth
});

function logout(){ auth.signOut().then(()=>window.location.href="index.html"); }
function showForm(){ document.getElementById('injuryForm').style.display='block'; }

async function uploadFile(file, playerName){
  if(!file) return null;
  const storageRef = storage.ref(`injury_docs/${playerName}_${Date.now()}_${file.name}`);
  const snapshot = await storageRef.put(file);
  return await snapshot.ref.getDownloadURL();
}

async function saveInjury(){
  const playerName = document.getElementById('playerName').value.trim();
  const teamName = document.getElementById('teamName').value.trim();
  const date = document.getElementById('injuryDate').value;
  const description = document.getElementById('injuryDescription').value.trim();
  const actions = document.getElementById('actionsTaken').value.trim();
  const headInjury = document.getElementById('headInjury').checked;
  const returnDate = document.getElementById('returnDate').value;
  const returnTime = document.getElementById('returnTime').value;
  const doctorNotes = document.getElementById('doctorNotes').value.trim();
  const file = document.getElementById('injuryFile').files[0];
  const injuryId = document.getElementById('injuryId').value;

  if(!playerName || !teamName || !date || !description){ alert('Fill required fields'); return; }
  if(headInjury && !doctorNotes && returnDate && returnTime){ alert('Doctor notes required for head injury'); return; }

  const fileUrl = await uploadFile(file, playerName);
  const injuryData = { playerName, teamName, date, description, actions, headInjury, returnDate, returnTime, doctorNotes, statusOverride:'', resolved:false, fileUrl:fileUrl||null, timestamp:firebase.firestore.FieldValue.serverTimestamp() };

  if(injuryId) await db.collection('injuries').doc(injuryId).update(injuryData);
  else await db.collection('injuries').add(injuryData);

  document.getElementById('injuryForm').reset();
  document.getElementById('injuryId').value='';
  document.getElementById('injuryForm').style.display='none';
  loadInjuries();
}

function editInjury(id){
  db.collection('injuries').doc(id).get().then(doc=>{
    const d = doc.data();
    document.getElementById('injuryId').value = id;
    document.getElementById('playerName').value = d.playerName;
    document.getElementById('teamName').value = d.teamName;
    document.getElementById('injuryDate').value = d.date;
    document.getElementById('injuryDescription').value = d.description;
    document.getElementById('actionsTaken').value = d.actions;
    document.getElementById('headInjury').checked = d.headInjury || false;
    document.getElementById('returnDate').value = d.returnDate || '';
    document.getElementById('returnTime').value = d.returnTime || '';
    document.getElementById('doctorNotes').value = d.doctorNotes || '';
    document.getElementById('injuryForm').style.display='block';
  });
}

function overrideStatus(docId, newStatus){
  db.collection('injuries').doc(docId).update({statusOverride:newStatus}).then(()=>loadInjuries());
}

function loadInjuries(){
  const tbody = document.getElementById('injuryList');
  const filter = document.getElementById('statusFilter').value;
  tbody.innerHTML='';

  let total=0, head=0, cleared=0;
  db.collection('injuries').orderBy('timestamp','desc').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const d = doc.data();
      const returnDT = d.returnDate && d.returnTime ? new Date(d.returnDate+'T'+d.returnTime) : null;
      let resolved = d.resolved || false;
      if(d.statusOverride==='Cleared' || (returnDT && returnDT<=new Date())) resolved=true;

      let statusClass='status-injured', statusText='Injured';
      if(resolved) { statusClass='status-cleared'; statusText='Cleared'; }
      else if(d.statusOverride==='Injured'){ statusClass='status-injured'; statusText='Injured (Admin)'; }
      else if(d.headInjury && !d.doctorNotes){ statusClass='status-alert'; statusText='Head Injury - Doctor Notes Required'; }

      total++; if(d.headInjury) head++; if(resolved) cleared++;
      if(filter==='injured' && resolved) return;
      if(filter==='cleared' && !resolved) return;
      if(filter==='headInjury' && !d.headInjury) return;

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${d.playerName}</td>
        <td>${d.teamName}</td>
        <td>${d.date}</td>
        <td>${d.description}</td>
        <td>${d.headInjury?'Yes':'No'}</td>
        <td>${d.actions}</td>
        <td>${d.returnDate||''} ${d.returnTime||''}</td>
        <td>${d.doctorNotes||''}</td>
        <td>${d.fileUrl?`<a href="${d.fileUrl}" target="_blank">View</a>`:''}</td>
        <td class="${statusClass}">${statusText}</td>
        <td>
          <select onchange="overrideStatus('${doc.id}', this.value)">
            <option value="">-- Override --</option>
            <option value="Cleared">Cleared</option>
            <option value="Injured">Injured</option>
          </select>
        </td>
        <td><button onclick="editInjury('${doc.id}')"><i class="fas fa-edit"></i> Edit</button></td>
        <td>${d.timestamp?d.timestamp.toDate().toLocaleString():''}</td>
      `;
      tbody.appendChild(tr);
    });

    document.querySelector('#totalInjuriesCard p').innerText=total;
    document.querySelector('#headInjuriesCard p').innerText=head;
    document.querySelector('#clearedPlayersCard p').innerText=cleared;
  });
}
</script>
</body>
</html>

