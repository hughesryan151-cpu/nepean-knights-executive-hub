<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Executive Dashboard – Nepean Knights</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Font Awesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
:root {
  --primary: #E41F26;
  --secondary: #FFD200;
  --accent: #000;
  --card-bg: #FFF;
  --bg-gradient: linear-gradient(135deg,#FFD200,#E41F26);
  --border-radius: 16px;
  --shadow-light: 0 4px 12px rgba(0,0,0,0.1);
  --shadow-heavy: 0 12px 25px rgba(0,0,0,0.2);
  --transition: 0.3s;
  --status-pending: #FF6B6B;
  --status-inprogress: #FF9800;
  --status-completed: #4CAF50;
  --font-main: 'Segoe UI', Arial, sans-serif;
}

/* Reset */
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:var(--font-main); min-height:100vh; background:var(--bg-gradient); color:#333; }

/* Header */
header { display:flex; justify-content:space-between; align-items:center; padding:0 30px; height:70px; background:#fff; box-shadow:var(--shadow-light); border-bottom:1px solid #eee; position:sticky; top:0; z-index:100; border-radius:0 0 var(--border-radius) var(--border-radius);}
header .logo-banner { display:flex; align-items:center; gap:15px; }
header img.logo, header img.banner { height:50px; }
header button { background:var(--primary); color:#fff; border:none; padding:10px 18px; border-radius:var(--border-radius); font-weight:bold; cursor:pointer; transition:var(--transition); }
header button:hover{ transform:translateY(-2px); opacity:0.9; }

/* Main */
main { max-width:1300px; margin:20px auto; padding:0 20px; }
h2 { text-align:center; color:#fff; font-size:2.4rem; margin-bottom:30px; text-shadow:1px 1px 4px rgba(0,0,0,0.3); }

/* Summary Grid */
.summary-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; margin-bottom:40px; }
.summary-card { background:var(--card-bg); border-radius:var(--border-radius); padding:25px; display:flex; flex-direction:column; align-items:center; box-shadow:var(--shadow-light); transition:var(--transition); }
.summary-card:hover { transform:translateY(-5px); box-shadow:var(--shadow-heavy); }
.summary-card i { font-size:2.5rem; margin-bottom:12px; color:var(--primary); }
.summary-card h4 { margin-bottom:8px; font-size:1.05rem; font-weight:600; color:#555; text-align:center; }
.summary-card span { font-size:1.7rem; font-weight:700; }

/* Search Bar */
#alertSearch { width:100%; padding:12px 15px; border-radius:12px; border:1px solid #ddd; font-size:1rem; margin-bottom:25px; transition:var(--transition); }
#alertSearch:focus { outline:none; box-shadow:0 0 10px rgba(0,0,0,0.15); }

/* Dashboard Grid */
.dashboard-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:25px; }
.dashboard-box { background:var(--card-bg); border-radius:var(--border-radius); padding:30px 20px; text-align:center; cursor:pointer; box-shadow:var(--shadow-light); position:relative; transition:var(--transition); }
.dashboard-box:hover { transform:translateY(-6px); box-shadow:var(--shadow-heavy); }
.dashboard-box i { font-size:3rem; color:var(--primary); margin-bottom:12px; }
.dashboard-box h3 { font-size:1.2rem; font-weight:600; margin-bottom:10px; }

/* Status Bar & Badge */
.status-bar { position:absolute; top:0; left:0; height:6px; border-radius:var(--border-radius) var(--border-radius) 0 0; width:0%; transition:0.5s; }
.badge { display:inline-block; padding:6px 14px; border-radius:12px; font-weight:600; font-size:0.85rem; margin-top:6px; color:#fff; transition:var(--transition); }
.badge-pending{background:var(--status-pending);}
.badge-inprogress{background:var(--status-inprogress);}
.badge-completed{background:var(--status-completed);}

/* Alerts Section */
.alerts { background:var(--card-bg); border-radius:var(--border-radius); padding:30px; box-shadow:var(--shadow-light); margin-top:35px; }
.alerts h3{ text-align:center; font-size:1.4rem; color:var(--primary); margin-bottom:20px; }
.alert-item { padding:14px 18px; border-left:5px solid var(--status-pending); margin-bottom:12px; border-radius:8px; background:#fdfdfd; opacity:0; transform:translateY(15px); animation:fadeInUp 0.5s forwards; }
@keyframes fadeInUp { to{opacity:1; transform:translateY(0);} }
.alerts p{text-align:center;color:var(--status-completed);font-weight:700;}
@media(max-width:768px){.dashboard-grid,.summary-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));}}
</style>
</head>
<body>

<header>
  <div class="logo-banner">
    <img src="nepean-knights-logo.png" alt="Logo" class="logo">
    <img src="knights-banner-updated.png" alt="Banner" class="banner">
  </div>
  <button onclick="logout()">Logout</button>
</header>

<main>
  <h2>Executive Dashboard</h2>

  <!-- Summary Stats -->
  <div class="summary-grid" id="summaryGrid"></div>

  <!-- Alerts Search -->
  <input type="text" id="alertSearch" placeholder="Search alerts..." oninput="filterAlerts()">

  <!-- Dashboard Modules -->
  <div class="dashboard-grid" id="dashboardGrid"></div>

  <!-- Alerts Section -->
  <div class="alerts" id="alertsSection">
    <h3>Alerts / Missing Items</h3>
    <div id="alertsList">Loading...</div>
  </div>
</main>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
  authDomain: "nepean-knights-executive-hub.firebaseapp.com",
  projectId: "nepean-knights-executive-hub",
});

const auth = firebase.auth();
const db = firebase.firestore();
auth.onAuthStateChanged(user => { if(!user) window.location.href='index.html'; });
function logout(){auth.signOut().then(()=>window.location.href='index.html');}

// Modules – Investigations removed
const modules=[
  {name:'House League', icon:'fas fa-users', link:'house-league.html'},
  {name:'Competitive', icon:'fas fa-trophy', link:'competitive.html'},
  {name:'Incidents', icon:'fas fa-exclamation-triangle', link:'incidents.html'},
  {name:'Suspensions', icon:'fas fa-ban', link:'suspensions.html'},
  {name:'Emergency Plans', icon:'fas fa-ambulance', link:'emergency-plans.html'},
  {name:'Arena Maintenance', icon:'fas fa-tools', link:'arena-maintenance.html'},
  {name:'Injuries', icon:'fas fa-procedures', link:'injuries.html'},
];

let alertsArr = [];

function loadDashboard(){
  const summaryGrid = document.getElementById('summaryGrid');
  const summaryMetrics = [
    {name:'Injured Players', icon:'fas fa-procedures', id:'injuredCount'},
    {name:'Active Suspensions', icon:'fas fa-ban', id:'suspensionCount'},
    {name:'Pending Work Orders', icon:'fas fa-tools', id:'workOrderCount'}
  ];
  summaryGrid.innerHTML='';
  summaryMetrics.forEach(s=>{
    const card=document.createElement('div'); card.className='summary-card';
    card.innerHTML=`<i class="${s.icon}"></i><h4>${s.name}</h4><span id="${s.id}">0</span>`;
    summaryGrid.appendChild(card);
  });

  const grid = document.getElementById('dashboardGrid'); grid.innerHTML='';
  modules.forEach(mod=>{
    const box = document.createElement('div'); box.className='dashboard-box';
    box.innerHTML=`
      <div class="status-bar" id="status-${mod.name.replace(/\s/g,'')}"></div>
      <i class="${mod.icon}"></i>
      <h3>${mod.name}</h3>
      <span class="badge" id="badge-${mod.name.replace(/\s/g,'')}" style="display:none;"></span>`;
    box.onclick=()=>window.location.href=mod.link;
    grid.appendChild(box);
  });

  setupRealtimeListeners();
}

// Badge helper
function updateBadge(id,count,label='Pending',status='pending'){
  const badge=document.getElementById(`badge-${id.replace(/\s/g,'')}`);
  const bar=document.getElementById(`status-${id.replace(/\s/g,'')}`);
  if(badge){
    if(count===0){ badge.style.display='none'; bar.style.width='0%'; return; }
    badge.style.display='inline-block';
    badge.textContent=`${count} ${label}`;
    badge.className=`badge badge-${status}`;
    bar.style.width=Math.min(count*12,100)+'%';
    bar.style.backgroundColor=status==='pending'? '#FF6B6B' : status==='inprogress'? '#FF9800' : '#4CAF50';
  }
}

// Alerts
function renderAlerts(){
  const alertsList=document.getElementById('alertsList');
  const searchText=document.getElementById('alertSearch').value.toLowerCase();
  const filtered=alertsArr.filter(a=>a.toLowerCase().includes(searchText));
  alertsList.innerHTML='';
  if(filtered.length===0){ alertsList.innerHTML='<p>All clear ✅</p>'; return; }
  filtered.forEach((alert,i)=>{
    const div=document.createElement('div'); div.className='alert-item';
    div.style.animationDelay=`${i*0.1}s`; div.textContent=alert;
    alertsList.appendChild(div);
  });
}
function filterAlerts(){ renderAlerts(); }

// Realtime listeners
function setupRealtimeListeners(){
  alertsArr=[];

  // Injuries
  db.collection('injuries').onSnapshot(snap=>{
    let injured=0;
    snap.forEach(doc=>{
      const d = doc.data();
      const now = new Date();
      const returnDT = d.returnDate && d.returnTime ? new Date(d.returnDate+'T'+d.returnTime) : null;
      let resolved = d.resolved || false;
      if(d.statusOverride === 'Cleared' || (returnDT && returnDT <= now)) resolved = true;
      if(!resolved) injured++;
      if(resolved && !d.resolved) db.collection('injuries').doc(doc.id).update({resolved: true});
    });
    document.getElementById('injuredCount').textContent = injured;
    updateBadge('Injuries', injured,'Active', injured>0?'inprogress':'completed');
  });

  // Suspensions
  db.collection('suspensions').onSnapshot(snap=>{
    let active=0;
    snap.forEach(doc=>{ if(!doc.data().completed) active++; });
    document.getElementById('suspensionCount').textContent = active;
    updateBadge('Suspensions', active,'Active','inprogress');
  });

  // Work Orders
  db.collection('arenaWorkOrders').onSnapshot(snap=>{
    let pending=0;
    snap.forEach(doc=>{ if(doc.data().status==='Pending') pending++; });
    document.getElementById('workOrderCount').textContent = pending;
    updateBadge('Arena Maintenance', pending,'Pending','pending');
  });

  const monitorCollection=(collection, processDoc, badgeId, status='pending', label='Pending')=>{
    db.collection(collection).onSnapshot(snap=>{
      let count=0;
      snap.forEach(doc=>{ if(processDoc(doc.data(),doc.id)){ count++; } });
      updateBadge(badgeId,count,label,status);
      renderAlerts();
    });
  };

  monitorCollection('houseLeague', (d,id)=>!d.NCCP||!d.VSC||!d.FirstAid && alertsArr.push(`${id} missing certificates`),'House League','pending');
  monitorCollection('competitive', (d,id)=>!d.NCCP||!d.VSC||!d.FirstAid && alertsArr.push(`${id} missing certificates`),'Competitive','pending');
  monitorCollection('incidents',(d,id)=>!d.resolved,'Incidents','pending');
}

loadDashboard();
</script>
</body>
</html>

