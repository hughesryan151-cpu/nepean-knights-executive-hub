<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Executive Dashboard – Nepean Knights</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Font Awesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
:root {
  --primary-color: #E41F26;
  --secondary-color: #FFD200;
  --accent-color: #000;
  --bg-gradient: linear-gradient(135deg,#FFD200,#E41F26);
  --card-bg: #FFF2CC;
  --ok-color: #4CAF50;
  --pending-color: #FF6B6B;
  --inprogress-color: #FF9800;
  --header-height: 70px;
  --border-radius: 12px;
  --transition-speed: 0.3s;
  --shadow-light: 0 2px 6px rgba(0,0,0,0.15);
  --shadow-heavy: 0 8px 20px rgba(0,0,0,0.25);
}

/* Reset & Body */
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Segoe UI',Arial,sans-serif; min-height:100vh; background:var(--bg-gradient); color:#333; }

/* Header */
header { display:flex; justify-content:space-between; align-items:center; background-color:var(--primary-color); color:var(--secondary-color); padding:0 20px; height:var(--header-height); box-shadow:var(--shadow-light); }
header .logo-banner { display:flex; align-items:center; gap:10px; }
header img.logo, header img.banner { height:50px; }
header button { background-color:var(--secondary-color); color:var(--accent-color); border:none; padding:10px 18px; border-radius:var(--border-radius); cursor:pointer; font-weight:bold; transition:opacity 0.2s; }
header button:hover{opacity:0.85;}

/* Main */
main { padding:20px; max-width:1200px; margin:0 auto; }
h2 { text-align:center; color:var(--primary-color); margin-bottom:15px; font-size:2rem; }

/* Summary Stats */
.summary-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:15px; margin-bottom:20px; }
.summary-card { background-color:var(--card-bg); border-radius:var(--border-radius); padding:15px; display:flex; flex-direction:column; align-items:center; box-shadow:var(--shadow-light); transition:transform 0.3s, box-shadow 0.3s; }
.summary-card:hover { transform:translateY(-4px); box-shadow:var(--shadow-heavy); }
.summary-card i { font-size:2rem; margin-bottom:8px; }
.summary-card h4 { margin-bottom:5px; font-size:1rem; color:#555; }
.summary-card span { font-size:1.5rem; font-weight:bold; }

/* Search Bar */
#alertSearch { width:100%; padding:10px 12px; margin-bottom:15px; border-radius:8px; border:1px solid #ccc; font-size:1rem; }

/* Dashboard Grid */
.dashboard-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; }
.dashboard-box { background-color:var(--card-bg); border-radius:var(--border-radius); padding:20px; text-align:center; cursor:pointer; box-shadow:var(--shadow-light); transition: transform var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed); position:relative; }
.dashboard-box:hover { transform:translateY(-6px); box-shadow:var(--shadow-heavy); }
.dashboard-box i { font-size:2.5rem; margin-bottom:10px; }
.dashboard-box h3 { margin:12px 0 8px; font-size:1.1rem; }

/* Status Bar */
.status-bar { position:absolute; top:0; left:0; height:6px; border-top-left-radius:12px; border-top-right-radius:12px; width:0%; transition:width 0.5s, background-color 0.3s; }

/* Badge */
.badge { display:inline-block; padding:5px 10px; border-radius:8px; font-weight:bold; color:#fff; font-size:0.85rem; margin-top:5px; transition: background-color 0.3s; }
.badge-pending{background-color:var(--pending-color);}
.badge-inprogress{background-color:var(--inprogress-color);}
.badge-completed{background-color:var(--ok-color);}

/* Alerts Section */
.alerts { background-color:var(--card-bg); border-radius:var(--border-radius); padding:20px; margin-top:25px; box-shadow:var(--shadow-light); transition:all var(--transition-speed);}
.alerts h3{ margin-bottom:10px; font-size:1.3rem; }
.alert-item { padding:10px 12px; border-left:5px solid var(--pending-color); margin-bottom:10px; border-radius:6px; background-color:rgba(255,255,255,0.6); opacity:0; transform:translateY(10px); animation:fadeInUp 0.5s forwards;}
@keyframes fadeInUp { to{opacity:1; transform:translateY(0);} }
.alerts p{text-align:center;color:var(--ok-color);font-weight:bold;}
@media(max-width:768px){.dashboard-grid, .summary-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));}}
</style>
</head>
<body>

<header>
  <div class="logo-banner">
    <img src="nepean-knights-logo.png" alt="Logo" class="logo">
    <img src="knights-banner-updated.png" alt="Banner" class="banner">
  </div>
  <button onclick="logout()">Logout</button>
</header>

<main>
  <h2>Executive Dashboard</h2>

  <!-- Summary Stats -->
  <div class="summary-grid" id="summaryGrid"></div>

  <!-- Alerts Search -->
  <input type="text" id="alertSearch" placeholder="Search alerts..." oninput="filterAlerts()">

  <!-- Dashboard Modules -->
  <div class="dashboard-grid" id="dashboardGrid"></div>

  <!-- Alerts Section -->
  <div class="alerts" id="alertsSection">
    <h3>Alerts / Missing Items</h3>
    <div id="alertsList">Loading...</div>
  </div>
</main>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
  authDomain: "nepean-knights-executive-hub.firebaseapp.com",
  projectId: "nepean-knights-executive-hub",
});

const auth = firebase.auth();
const db = firebase.firestore();
auth.onAuthStateChanged(user => { if(!user) window.location.href='index.html'; });
function logout(){auth.signOut().then(()=>window.location.href='index.html');}

const modules=[
  {name:'House League', icon:'fas fa-users', link:'house-league.html'},
  {name:'Competitive', icon:'fas fa-trophy', link:'competitive.html'},
  {name:'Incidents', icon:'fas fa-exclamation-triangle', link:'incidents.html'},
  {name:'Investigations', icon:'fas fa-search', link:'investigations.html'},
  {name:'Suspensions', icon:'fas fa-ban', link:'suspensions.html'},
  {name:'Emergency Plans', icon:'fas fa-ambulance', link:'emergency-plans.html'},
  {name:'Arena Maintenance', icon:'fas fa-tools', link:'arena-maintenance.html'},
  {name:'Injuries', icon:'fas fa-procedures', link:'injuries.html'},
];

let alertsArr = [];

function loadDashboard(){
  const summaryGrid = document.getElementById('summaryGrid');
  const summaryMetrics = [
    {name:'Injured Players', icon:'fas fa-procedures', id:'injuredCount'},
    {name:'Active Suspensions', icon:'fas fa-ban', id:'suspensionCount'},
    {name:'Pending Work Orders', icon:'fas fa-tools', id:'workOrderCount'},
    {name:'Pending Investigations', icon:'fas fa-search', id:'investigationCount'}
  ];
  summaryGrid.innerHTML='';
  summaryMetrics.forEach(s=>{
    const card=document.createElement('div'); card.className='summary-card';
    card.innerHTML=`<i class="${s.icon}"></i><h4>${s.name}</h4><span id="${s.id}">0</span>`;
    summaryGrid.appendChild(card);
  });

  const grid = document.getElementById('dashboardGrid'); grid.innerHTML='';
  modules.forEach(mod=>{
    const box = document.createElement('div'); box.className='dashboard-box';
    box.innerHTML=`
      <div class="status-bar" id="status-${mod.name.replace(/\s/g,'')}"></div>
      <i class="${mod.icon}" style="color:#E41F26"></i>
      <h3>${mod.name}</h3>
      <span class="badge" id="badge-${mod.name.replace(/\s/g,'')}" style="display:none;"></span>`;
    box.onclick=()=>window.location.href=mod.link;
    grid.appendChild(box);
  });

  setupRealtimeListeners();
}

// Update badge helper
function updateBadge(id,count,label='Pending',status='pending'){
  const badge=document.getElementById(`badge-${id.replace(/\s/g,'')}`);
  const bar=document.getElementById(`status-${id.replace(/\s/g,'')}`);
  if(badge){
    if(count===0){ badge.style.display='none'; bar.style.width='0%'; return; }
    badge.style.display='inline-block';
    badge.textContent=`${count} ${label}`;
    badge.className=`badge badge-${status}`;
    bar.style.width=Math.min(count*10,100)+'%';
    bar.style.backgroundColor=status==='pending'? '#FF6B6B' : status==='inprogress'? '#FF9800' : '#4CAF50';
  }
}

// Alerts render
function renderAlerts(){
  const alertsList=document.getElementById('alertsList');
  const searchText=document.getElementById('alertSearch').value.toLowerCase();
  const filtered=alertsArr.filter(a=>a.toLowerCase().includes(searchText));
  alertsList.innerHTML='';
  if(filtered.length===0){ alertsList.innerHTML='<p>All clear ✅</p>'; return; }
  filtered.forEach((alert,i)=>{
    const div=document.createElement('div'); div.className='alert-item';
    div.style.animationDelay=`${i*0.1}s`; div.textContent=alert;
    alertsList.appendChild(div);
  });
}
function filterAlerts(){ renderAlerts(); }

// Realtime listeners
function setupRealtimeListeners(){
  alertsArr=[];

  // Injured Players: automatically skip cleared injuries
  db.collection('injuries').onSnapshot(snap=>{
    let injured=0;
    snap.forEach(doc=>{
      const d = doc.data();
      const now = new Date();
      const returnDT = d.returnDate && d.returnTime ? new Date(d.returnDate+'T'+d.returnTime) : null;

      // Auto mark resolved if cleared or return time passed
      let resolved = d.resolved || false;
      if(d.statusOverride === 'Cleared' || (returnDT && returnDT <= now)) resolved = true;

      if(!resolved) injured++;
      // Update Firestore if resolved changed
      if(resolved && !d.resolved) db.collection('injuries').doc(doc.id).update({resolved: true});
    });
    document.getElementById('injuredCount').textContent = injured;
    updateBadge('Injuries', injured,'Active', injured>0?'inprogress':'completed');
  });

  // Active Suspensions
  db.collection('suspensions').onSnapshot(snap=>{
    let active=0;
    snap.forEach(doc=>{ if(!doc.data().completed) active++; });
    document.getElementById('suspensionCount').textContent = active;
    updateBadge('Suspensions', active,'Active','inprogress');
  });

  // Pending Work Orders
  db.collection('arenaWorkOrders').onSnapshot(snap=>{
    let pending=0;
    snap.forEach(doc=>{ if(doc.data().status==='Pending') pending++; });
    document.getElementById('workOrderCount').textContent = pending;
    updateBadge('Arena Maintenance', pending,'Pending','pending');
  });

  // Pending Investigations
  db.collection('investigations').onSnapshot(snap=>{
    let pending=0;
    snap.forEach(doc=>{ if(!doc.data().resolved) pending++; });
    document.getElementById('investigationCount').textContent = pending;
    updateBadge('Investigations', pending,'Pending','pending');
  });

  const monitorCollection=(collection, processDoc, badgeId, status='pending', label='Pending')=>{
    db.collection(collection).onSnapshot(snap=>{
      let count=0;
      snap.forEach(doc=>{ if(processDoc(doc.data(),doc.id)){ count++; } });
      updateBadge(badgeId,count,label,status);
      renderAlerts();
    });
  };

  monitorCollection('houseLeague', (d,id)=>!d.NCCP||!d.VSC||!d.FirstAid && alertsArr.push(`${id} missing certificates`),'House League','pending');
  monitorCollection('competitive', (d,id)=>!d.NCCP||!d.VSC||!d.FirstAid && alertsArr.push(`${id} missing certificates`),'Competitive','pending');
  monitorCollection('incidents',(d,id)=>!d.resolved,'Incidents','pending');
}

loadDashboard();
</script>
</body>
</html>

