<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nepean Knights – Executive Hub</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #E41F26;
            --primary-hover: #b3181d;
            --secondary: #FFD200;
            --dark: #1a1a1a;
            --light-bg: #f4f7f6;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 8px;
            --success: #28a745;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--light-bg); color: var(--dark); }
        header { background: var(--dark); color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--primary); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Buttons */
        .btn { cursor: pointer; border: none; border-radius: var(--radius); padding: 10px 18px; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: #dc3545; color: white; }

        /* Tabs */
        .tabs-nav { margin: 20px 0; display: flex; gap: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 12px 10px; cursor: pointer; font-weight: bold; color: #777; position: relative; }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--primary); }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: var(--white); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border-top: 4px solid var(--secondary); display: flex; flex-direction: column; gap: 10px; }
        .card h4 { margin: 0; }
        .card-meta { font-size: 0.8rem; color: #888; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: var(--white); width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: var(--radius); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .span-2 { grid-column: span 2; }
        label { font-weight: bold; font-size: 0.85rem; margin-bottom: 5px; display: block; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
        
        .hidden { display: none; }
        .status-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>

<body>

<header>
    <div><h2 style="margin:0">Nepean Knights</h2><small>Executive Incident Portal</small></div>
    <div style="display:flex; align-items:center; gap:15px;">
        <span id="userEmail" style="font-size:0.8rem"></span>
        <button class="btn btn-outline" style="color:white" id="btnLogout">Logout</button>
    </div>
</header>

<div class="container">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <div class="tabs-nav">
            <div class="tab active" data-tab="incidents">Active Incidents</div>
            <div class="tab" data-tab="investigations">Active Investigations</div>
            <div class="tab" data-tab="archive">Archive (Closed Cases)</div>
        </div>
        <button class="btn btn-primary" onclick="openIncidentModal()">＋ New Incident</button>
    </div>

    <div id="incidentList" class="grid"></div>
    <div id="investigationList" class="grid hidden"></div>
    <div id="archiveList" class="grid hidden"></div>
</div>

<div class="modal" id="incidentModal">
    <div class="modal-content">
        <h2>Incident Report</h2>
        <div class="form-grid">
            <div><label>Date</label><input type="date" id="iDate"></div>
            <div><label>Team</label><input type="text" id="iTeam"></div>
            <div class="span-2"><label>Description</label><textarea id="iDescription" rows="4"></textarea></div>
            <div class="span-2"><label>Internal Notes</label><textarea id="iNotes" rows="2"></textarea></div>
        </div>
        <div style="margin-top:20px; display:flex; justify-content: flex-end; gap:10px;">
            <button class="btn btn-outline" onclick="closeModals()">Cancel</button>
            <button class="btn btn-danger" id="btnCloseIncident">Close & Archive</button>
            <button class="btn btn-primary" id="btnSaveIncident">Save</button>
            <button class="btn btn-success" id="btnPromote">Promote to Investigation</button>
        </div>
    </div>
</div>

<div class="modal" id="investigationModal">
    <div class="modal-content">
        <h2>Investigation File</h2>
        <div class="form-grid">
            <div class="span-2"><label>Case Summary</label><textarea id="vSummary" rows="2"></textarea></div>
            <textarea id="vPlayers" placeholder="Players Involved"></textarea>
            <textarea id="vEvidence" placeholder="Evidence Links"></textarea>
            <textarea id="vFindings" class="span-2" placeholder="Findings of Fact"></textarea>
            <textarea id="vOutcome" class="span-2" placeholder="Final Decision / Sanction"></textarea>
        </div>
        <div style="margin-top:20px; display:flex; justify-content: flex-end; gap:10px;">
            <button class="btn btn-outline" onclick="closeModals()">Back</button>
            <button class="btn btn-danger" id="btnCloseInvestigation">Close & Archive Case</button>
            <button class="btn btn-primary" id="btnSaveInvestigation">Save Progress</button>
        </div>
    </div>
</div>

<script>
/* ================= FIREBASE SETUP ================= */
const firebaseConfig = {
    apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
    authDomain: "nepean-knights-executive-hub.firebaseapp.com",
    projectId: "nepean-knights-executive-hub"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentId = null;
let currentInvId = null;
let userEmail = "";

auth.onAuthStateChanged(user => {
    if (!user) window.location.href = "index.html";
    userEmail = user.email;
    document.getElementById('userEmail').innerText = userEmail;
});

/* ================= AUDIT LOGGING ================= */
async function audit(action, docId, type) {
    await db.collection('audit_logs').add({
        executive: userEmail,
        action: action,
        docId: docId,
        type: type,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
}

/* ================= TAB NAVIGATION ================= */
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.tab;
        document.getElementById('incidentList').classList.toggle('hidden', target !== 'incidents');
        document.getElementById('investigationList').classList.toggle('hidden', target !== 'investigations');
        document.getElementById('archiveList').classList.toggle('hidden', target !== 'archive');
    });
});

function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }

/* ================= DATA LOADING ================= */

// Load Incidents (Active)
db.collection('incidents').where('status', '==', 'active').onSnapshot(snap => {
    const list = document.getElementById('incidentList');
    list.innerHTML = '';
    snap.forEach(doc => {
        const d = doc.data();
        list.innerHTML += `<div class="card">
            <div class="card-meta">${d.incidentDate}</div>
            <h4>${d.team}</h4>
            <p>${d.description?.substring(0,80)}...</p>
            <button class="btn btn-outline" onclick="editIncident('${doc.id}')">Open</button>
        </div>`;
    });
});

// Load Investigations (Active)
db.collection('investigations').where('status', '==', 'active').onSnapshot(snap => {
    const list = document.getElementById('investigationList');
    list.innerHTML = '';
    snap.forEach(doc => {
        const d = doc.data();
        list.innerHTML += `<div class="card" style="border-top-color:var(--primary)">
            <div class="card-meta">INVESTIGATION</div>
            <h4>${d.team || 'Case File'}</h4>
            <button class="btn btn-primary" onclick="editInvestigation('${doc.id}')">View File</button>
        </div>`;
    });
});

// Load Archive (Both Incidents and Investigations)
function loadArchive() {
    const list = document.getElementById('archiveList');
    list.innerHTML = '';
    
    // Get Closed Incidents
    db.collection('incidents').where('status', '==', 'archived').get().then(snap => {
        snap.forEach(doc => renderArchiveItem(doc.data(), 'Incident Archive'));
    });
    // Get Closed Investigations
    db.collection('investigations').where('status', '==', 'archived').get().then(snap => {
        snap.forEach(doc => renderArchiveItem(doc.data(), 'Investigation Archive'));
    });
}
function renderArchiveItem(d, label) {
    document.getElementById('archiveList').innerHTML += `<div class="card" style="opacity:0.7; border-top-color:#666">
        <div class="status-tag" style="background:#666; color:white; width:fit-content">${label}</div>
        <h4>${d.team || 'Archived'}</h4>
        <p>${d.incidentDate || ''}</p>
    </div>`;
}
document.querySelector('[data-tab="archive"]').addEventListener('click', loadArchive);

/* ================= ACTIONS ================= */

function openIncidentModal() {
    currentId = null;
    document.getElementById('iDate').value = '';
    document.getElementById('iTeam').value = '';
    document.getElementById('iDescription').value = '';
    document.getElementById('iNotes').value = '';
    document.getElementById('incidentModal').style.display = 'flex';
}

async function editIncident(id) {
    currentId = id;
    const doc = await db.collection('incidents').doc(id).get();
    const d = doc.data();
    document.getElementById('iDate').value = d.incidentDate;
    document.getElementById('iTeam').value = d.team;
    document.getElementById('iDescription').value = d.description;
    document.getElementById('iNotes').value = d.notes;
    document.getElementById('incidentModal').style.display = 'flex';
}

document.getElementById('btnSaveIncident').onclick = async () => {
    const data = {
        incidentDate: document.getElementById('iDate').value,
        team: document.getElementById('iTeam').value,
        description: document.getElementById('iDescription').value,
        notes: document.getElementById('iNotes').value,
        status: 'active',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    if (currentId) {
        await db.collection('incidents').doc(currentId).update(data);
        audit('Updated Incident', currentId, 'incident');
    } else {
        const ref = await db.collection('incidents').add(data);
        audit('Created Incident', ref.id, 'incident');
    }
    closeModals();
};

document.getElementById('btnCloseIncident').onclick = async () => {
    if (!currentId) return;
    if (confirm("Archive this incident? It will be moved to history.")) {
        await db.collection('incidents').doc(currentId).update({ status: 'archived' });
        audit('Archived Incident', currentId, 'incident');
        closeModals();
    }
};

document.getElementById('btnPromote').onclick = async () => {
    if (!currentId) return alert("Save first");
    const doc = await db.collection('incidents').doc(currentId).get();
    const d = doc.data();
    const invRef = await db.collection('investigations').add({
        team: d.team,
        incidentDate: d.incidentDate,
        summary: d.description,
        status: 'active',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection('incidents').doc(currentId).update({ status: 'archived' });
    audit('Promoted to Investigation', invRef.id, 'investigation');
    closeModals();
};

async function editInvestigation(id) {
    currentInvId = id;
    const doc = await db.collection('investigations').doc(id).get();
    const d = doc.data();
    document.getElementById('vSummary').value = d.summary || '';
    document.getElementById('vPlayers').value = d.players || '';
    document.getElementById('vEvidence').value = d.evidence || '';
    document.getElementById('vFindings').value = d.findings || '';
    document.getElementById('vOutcome').value = d.outcome || '';
    document.getElementById('investigationModal').style.display = 'flex';
}

document.getElementById('btnSaveInvestigation').onclick = async () => {
    await db.collection('investigations').doc(currentInvId).update({
        summary: document.getElementById('vSummary').value,
        players: document.getElementById('vPlayers').value,
        evidence: document.getElementById('vEvidence').value,
        findings: document.getElementById('vFindings').value,
        outcome: document.getElementById('vOutcome').value
    });
    audit('Updated Investigation', currentInvId, 'investigation');
    closeModals();
};

document.getElementById('btnCloseInvestigation').onclick = async () => {
    if (confirm("Close this case and archive the decision?")) {
        await db.collection('investigations').doc(currentInvId).update({ status: 'archived' });
        audit('Archived Investigation', currentInvId, 'investigation');
        closeModals();
    }
};

document.getElementById('btnLogout').onclick = () => auth.signOut();
</script>

</body>
</html>
