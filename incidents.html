<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Incident & Investigation Dashboard</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background-color: #f2f3f5;
  font-family: Arial, sans-serif;
}

header {
  background: #E41F26;
  color: #FFD200;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
}

.container {
  padding: 20px;
  background-color: #f2f3f5;
  min-height: 100vh;
}

button {
  padding: 8px 14px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}

.primary { background:#E41F26; color:#FFD200; }
.secondary { background:#ddd; }

.tab {
  display: inline-block;
  padding: 10px 15px;
  background: #FFD200;
  margin-right: 5px;
  cursor: pointer;
  border-radius: 4px;
}

.tab.active { background:#E41F26; color:#FFD200; }

.card {
  background: white;
  padding: 15px;
  margin-top: 10px;
  border-radius: 6px;
}

.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: #f2f3f5;
  width: 750px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 20px;
  border-radius: 8px;
}

input, textarea {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
}

textarea { height: 120px; }

.hidden { display: none; }
</style>
</head>

<body>

<header>
  <h2>Incident Dashboard</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">
  <button class="primary" onclick="openIncident()">➕ Create Incident</button>

  <div style="margin-top:15px;">
    <span class="tab active" onclick="showTab('active', this)">Active Incidents</span>
    <span class="tab" onclick="showTab('closed', this)">Closed Incidents</span>
    <span class="tab" onclick="showTab('investigations', this)">Investigations</span>
  </div>

  <div id="active"></div>
  <div id="closed" class="hidden"></div>
  <div id="investigations" class="hidden"></div>
</div>

<!-- INCIDENT MODAL -->
<div class="modal" id="incidentModal">
  <div class="modal-content">
    <button class="secondary" onclick="closeIncident()">← Back to Dashboard View</button>
    <button class="secondary" onclick="location.href='dashboard.html'">← Back to Dashboard.html</button>

    <h3>Incident</h3>

    <input id="iDate" type="date">
    <input id="iTeam" placeholder="Team">
    <input id="iArena" placeholder="Arena">
    <textarea id="iDescription" placeholder="Incident Description"></textarea>
    <textarea id="iNotes" placeholder="Notes"></textarea>

    <button class="primary" onclick="saveIncident()">Save</button>
    <button onclick="closeIncidentStatus()">Close</button>
    <button onclick="reopenIncident()">Reopen</button>
    <button onclick="deleteIncident()">Delete</button>
    <button onclick="sendToInvestigation()">Send to Investigation</button>
  </div>
</div>

<!-- INVESTIGATION MODAL -->
<div class="modal" id="investigationModal">
  <div class="modal-content">
    <button class="secondary" onclick="closeInvestigation()">← Back</button>

    <h3>Investigation</h3>

    <input id="vDate" type="date">
    <input id="vTeam">
    <input id="vArena">
    <textarea id="vDescription"></textarea>
    <textarea id="vNotes" placeholder="Investigation Notes"></textarea>

    <button class="primary" onclick="saveInvestigation()">Save</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
  authDomain: "nepean-knights-executive-hub.firebaseapp.com",
  projectId: "nepean-knights-executive-hub"
});

const db = firebase.firestore();
let incidentId = null;
let investigationId = null;

function showTab(id, el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  ['active','closed','investigations'].forEach(x=>document.getElementById(x).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function openIncident(data=null){
  incidentModal.style.display='flex';
  incidentId = data?.id || null;
  iDate.value = data?.incidentDate || '';
  iTeam.value = data?.team || '';
  iArena.value = data?.arena || '';
  iDescription.value = data?.description || '';
  iNotes.value = data?.notes || '';
}

function closeIncident(){
  incidentModal.style.display='none';
  incidentId=null;
}

function saveIncident(){
  const payload={
    incidentDate:iDate.value,
    team:iTeam.value,
    arena:iArena.value,
    description:iDescription.value,
    notes:iNotes.value,
    status:'open',
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  };
  incidentId
    ? db.collection('incidents').doc(incidentId).update(payload)
    : db.collection('incidents').add(payload);
  closeIncident();
}

function closeIncidentStatus(){
  db.collection('incidents').doc(incidentId).update({status:'closed'});
  closeIncident();
}

function reopenIncident(){
  db.collection('incidents').doc(incidentId).update({status:'open'});
  closeIncident();
}

function deleteIncident(){
  if(confirm('Delete this incident?')){
    db.collection('incidents').doc(incidentId).delete();
    closeIncident();
  }
}

function sendToInvestigation(){
  db.collection('incidents').doc(incidentId).get().then(d=>{
    db.collection('investigations').add({...d.data(), status:'open'});
  });
}

db.collection('incidents').onSnapshot(s=>{
  active.innerHTML=''; closed.innerHTML='';
  s.forEach(doc=>{
    const d=doc.data();
    const c=document.createElement('div');
    c.className='card';
    c.innerHTML=`<b>${d.team}</b><br>${d.description}<br>
    <button onclick='openIncident(${JSON.stringify({...d,id:doc.id})})'>Open</button>`;
    (d.status==='closed'?closed:active).appendChild(c);
  });
});

db.collection('investigations').onSnapshot(s=>{
  investigations.innerHTML='';
  s.forEach(doc=>{
    const d=doc.data();
    const c=document.createElement('div');
    c.className='card';
    c.innerHTML=`<b>${d.team}</b><br>${d.description}`;
    investigations.appendChild(c);
  });
});
</script>
</body>
</html>


