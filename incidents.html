<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nepean Knights – Incident Dashboard</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
header{background:#E41F26;color:#FFD200;padding:10px 20px;display:flex;justify-content:space-between}
button{padding:8px 12px;border:none;border-radius:5px;cursor:pointer;font-weight:bold}
.primary{background:#E41F26;color:#FFD200}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:6px}
.hidden{display:none}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:20px;width:600px;max-height:90vh;overflow:auto;border-radius:6px}
textarea,input{width:100%;padding:8px;margin:5px 0}
.tab{cursor:pointer;padding:10px;background:#FFD200;display:inline-block;margin-right:5px}
.tab.active{background:#E41F26;color:#FFD200}
</style>
</head>

<body>

<header>
<h2>Nepean Knights Dashboard</h2>
<button onclick="logout()">Logout</button>
</header>

<div style="padding:20px">
<button class="primary" onclick="openIncidentModal()">➕ Create Incident</button>

<div style="margin-top:15px">
<span class="tab active" onclick="switchTab('activeIncidents')">Active Incidents</span>
<span class="tab" onclick="switchTab('closedIncidents')">Closed Incidents</span>
<span class="tab" onclick="switchTab('investigations')">Investigations</span>
</div>

<div id="activeIncidents"></div>
<div id="closedIncidents" class="hidden"></div>
<div id="investigations" class="hidden"></div>
</div>

<!-- INCIDENT MODAL -->
<div class="modal" id="incidentModal">
<div class="modal-content">
<button onclick="closeIncidentModal()">⬅ Back to Dashboard</button>
<h3 id="incidentModalTitle">Incident</h3>

<input id="incidentDate" type="date">
<input id="team" placeholder="Team">
<input id="arena" placeholder="Arena">
<textarea id="description" placeholder="Description"></textarea>
<textarea id="notes" placeholder="Notes"></textarea>

<button class="primary" onclick="saveIncident()">Save</button>
<button onclick="closeIncident()">Close Incident</button>
<button onclick="reopenIncident()">Reopen Incident</button>
<button onclick="printIncident()">Print</button>
<button onclick="sendToInvestigation()">Send to Investigation</button>
</div>
</div>

<!-- INVESTIGATION MODAL -->
<div class="modal" id="investigationModal">
<div class="modal-content">
<button onclick="closeInvestigationModal()">⬅ Back</button>
<h3>Investigation</h3>
<textarea id="investigationNotes" style="height:150px"></textarea>
<button class="primary" onclick="saveInvestigation()">Save</button>
<button onclick="reopenInvestigation()">Reopen</button>
<button onclick="printInvestigation()">Print</button>
</div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
authDomain:"nepean-knights-executive-hub.firebaseapp.com",
projectId:"nepean-knights-executive-hub"
});
const auth=firebase.auth();
const db=firebase.firestore();

/* STATE */
let currentIncident=null;
let currentInvestigation=null;

/* AUTH */
auth.onAuthStateChanged(u=>{if(!u)location="index.html"});
function logout(){auth.signOut()}

/* TABS */
function switchTab(id){
["activeIncidents","closedIncidents","investigations"].forEach(d=>{
document.getElementById(d).classList.add("hidden");
});
document.getElementById(id).classList.remove("hidden");
document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
event.target.classList.add("active");
}

/* INCIDENTS */
function openIncidentModal(data=null){
document.getElementById("incidentModal").style.display="flex";
currentIncident=data?.id||null;
if(data){
incidentDate.value=data.incidentDate;
team.value=data.team;
arena.value=data.arena;
description.value=data.description;
notes.value=data.notes;
}else{
incidentDate.value="";
team.value="";
arena.value="";
description.value="";
notes.value="";
}
}

function closeIncidentModal(){
document.getElementById("incidentModal").style.display="none";
currentIncident=null;
}

function saveIncident(){
const payload={
incidentDate:incidentDate.value,
team:team.value,
arena:arena.value,
description:description.value,
notes:notes.value,
status:"open",
timestamp:firebase.firestore.FieldValue.serverTimestamp()
};
if(currentIncident){
db.collection("incidents").doc(currentIncident).update(payload);
}else{
db.collection("incidents").add(payload);
}
closeIncidentModal();
loadIncidents();
}

function closeIncident(){
if(currentIncident)
db.collection("incidents").doc(currentIncident).update({status:"closed"});
closeIncidentModal();loadIncidents();
}
function reopenIncident(){
if(currentIncident)
db.collection("incidents").doc(currentIncident).update({status:"open"});
closeIncidentModal();loadIncidents();
}

function sendToInvestigation(){
db.collection("incidents").doc(currentIncident).get().then(d=>{
db.collection("investigations").add({...d.data(),status:"open"});
});
}

function printIncident(){
window.print();
}

/* LOAD INCIDENTS */
function loadIncidents(){
activeIncidents.innerHTML="";
closedIncidents.innerHTML="";
db.collection("incidents").orderBy("timestamp","desc").onSnapshot(s=>{
s.forEach(doc=>{
const d=doc.data();
const div=document.createElement("div");
div.className="card";
div.innerHTML=`<b>${d.team}</b><br>${d.description}<br>
<button onclick='openIncidentModal(${JSON.stringify({...d,id:doc.id})})'>Open</button>`;
(d.status==="open"?activeIncidents:closedIncidents).appendChild(div);
});
});
}

/* INVESTIGATIONS */
function loadInvestigations(){
investigations.innerHTML="";
db.collection("investigations").onSnapshot(s=>{
s.forEach(doc=>{
const d=doc.data();
const div=document.createElement("div");
div.className="card";
div.innerHTML=`${d.team}<br>
<button onclick='openInvestigation("${doc.id}")'>Open</button>`;
investigations.appendChild(div);
});
});
}

function openInvestigation(id){
currentInvestigation=id;
db.collection("investigations").doc(id).get().then(d=>{
investigationNotes.value=d.data().notes||"";
investigationModal.style.display="flex";
});
}
function closeInvestigationModal(){
investigationModal.style.display="none";
}
function saveInvestigation(){
db.collection("investigations").doc(currentInvestigation).update({
notes:investigationNotes.value
});
closeInvestigationModal();
}
function reopenInvestigation(){
db.collection("investigations").doc(currentInvestigation).update({status:"open"});
closeInvestigationModal();
}
function printInvestigation(){window.print();}

/* INIT */
loadIncidents();
loadInvestigations();
</script>
</body>
</html>

