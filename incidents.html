<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nepean Knights â€“ Executive Hub</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #E41F26;
            --secondary: #FFD200;
            --dark: #1a1a1a;
            --bg: #f4f7f6;
            --white: #ffffff;
            --grey: #6c757d;
            --danger: #dc3545;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--dark); }
        header { background: var(--dark); color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--primary); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Buttons */
        .btn { cursor: pointer; border: none; border-radius: 6px; padding: 10px 18px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-archive { background: var(--grey); color: white; }

        /* Tabs */
        .tabs-nav { margin: 20px 0; display: flex; gap: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 12px 15px; cursor: pointer; font-weight: bold; color: #777; position: relative; }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 4px; background: var(--primary); }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: var(--white); border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid var(--secondary); display: flex; flex-direction: column; gap: 10px; }
        .card.archived { border-top-color: var(--grey); opacity: 0.8; }
        
        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: var(--white); width: 100%; max-width: 850px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 10px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .span-2 { grid-column: span 2; }
        label { font-weight: bold; font-size: 0.85rem; display: block; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
        
        .hidden { display: none; }
        .badge { font-size: 0.7rem; padding: 3px 7px; border-radius: 4px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: inline-block; }
    </style>
</head>

<body>

<header>
    <h2>Nepean Knights â€“ Executive Hub</h2>
    <div style="display:flex; align-items:center; gap:20px;">
        <span id="userEmail" style="font-size:0.9rem"></span>
        <button class="btn btn-outline" style="color:white; border-color:white;" onclick="logout()">Logout</button>
    </div>
</header>

<div class="container">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <div class="tabs-nav">
            <div class="tab active" id="tab-incidents" onclick="switchTab('incidents')">Active Incidents</div>
            <div class="tab" id="tab-investigations" onclick="switchTab('investigations')">Active Investigations</div>
            <div class="tab" id="tab-archive" onclick="switchTab('archive')">Archive (Closed)</div>
        </div>
        <button class="btn btn-primary" onclick="openNewIncident()">ï¼‹ New Incident</button>
    </div>

    <div id="section-incidents" class="grid"></div>
    <div id="section-investigations" class="grid hidden"></div>
    <div id="section-archive" class="grid hidden"></div>
</div>

<div class="modal" id="incidentModal">
    <div class="modal-content">
        <h2 id="incHeader">Incident Report</h2>
        <div class="form-grid">
            <div><label>Date</label><input type="date" id="iDate"></div>
            <div><label>Team</label><input type="text" id="iTeam"></div>
            <div class="span-2"><label>Description</label><textarea id="iDescription" rows="5"></textarea></div>
            <div class="span-2"><label>Internal Office Notes</label><textarea id="iNotes" rows="2"></textarea></div>
        </div>
        <div style="margin-top:25px; display:flex; justify-content: space-between;">
            <button class="btn btn-danger" id="btnDeleteIncident" onclick="deleteCurrentIncident()">ðŸ—‘ Delete Forever</button>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="closeModals()">Cancel</button>
                <button class="btn btn-archive" id="btnArchiveIncident" onclick="archiveCurrentIncident()">Close & Archive</button>
                <button class="btn btn-primary" onclick="saveIncident()">Save Changes</button>
                <button class="btn btn-success" id="btnPromote" onclick="promoteToInvestigation()">Promote</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="investigationModal">
    <div class="modal-content">
        <h2>Investigation File</h2>
        <div class="form-grid">
            <div class="span-2"><label>Case Summary</label><textarea id="vSummary"></textarea></div>
            <div class="span-2"><label>Players / Coaches Involved</label><textarea id="vPeople"></textarea></div>
            <div class="span-2"><label>Findings & Outcomes</label><textarea id="vFindings" rows="6"></textarea></div>
        </div>
        <div style="margin-top:25px; display:flex; justify-content: space-between;">
            <button class="btn btn-danger" id="btnDeleteInvestigation" onclick="deleteCurrentInvestigation()">ðŸ—‘ Delete File</button>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="closeModals()">Close</button>
                <button class="btn btn-archive" id="btnArchiveInv" onclick="archiveCurrentInvestigation()">Finalize & Archive</button>
                <button class="btn btn-primary" onclick="saveInvestigation()">Save Progress</button>
            </div>
        </div>
    </div>
</div>

<script>
/* ================= FIREBASE INITIALIZATION ================= */
const firebaseConfig = {
    apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
    authDomain: "nepean-knights-executive-hub.firebaseapp.com",
    projectId: "nepean-knights-executive-hub"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentId = null;
let currentInvId = null;
let userEmail = "";

auth.onAuthStateChanged(user => {
    if (!user) window.location.href = "index.html";
    userEmail = user.email;
    document.getElementById('userEmail').innerText = userEmail;
});

function logout() { auth.signOut(); }

async function auditLog(action, docId, type) {
    await db.collection('audit_logs').add({
        user: userEmail,
        action: action,
        id: docId,
        type: type,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
}

/* ================= TAB SYSTEM ================= */
function switchTab(type) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + type).classList.add('active');
    document.getElementById('section-incidents').classList.toggle('hidden', type !== 'incidents');
    document.getElementById('section-investigations').classList.toggle('hidden', type !== 'investigations');
    document.getElementById('section-archive').classList.toggle('hidden', type !== 'archive');
    if(type === 'archive') loadArchive();
}

function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

/* ================= INCIDENT LOGIC ================= */
db.collection('incidents').orderBy('timestamp', 'desc').onSnapshot(snap => {
    const list = document.getElementById('section-incidents');
    list.innerHTML = '';
    snap.forEach(doc => {
        const d = doc.data();
        if (d.status === 'archived') return;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<small>${d.incidentDate || ''}</small><h4>${d.team || 'Unknown'}</h4><p>${(d.description || '').substring(0, 100)}...</p><button class="btn btn-outline" onclick="editIncident('${doc.id}')">Open Report</button>`;
        list.appendChild(card);
    });
});

function openNewIncident() {
    currentId = null;
    document.getElementById('incHeader').innerText = "New Incident Report";
    document.getElementById('iDate').value = ""; document.getElementById('iTeam').value = "";
    document.getElementById('iDescription').value = ""; document.getElementById('iNotes').value = "";
    document.getElementById('btnArchiveIncident').style.display = 'none';
    document.getElementById('btnDeleteIncident').style.display = 'none';
    document.getElementById('btnPromote').style.display = 'none';
    document.getElementById('incidentModal').style.display = 'flex';
}

async function editIncident(id) {
    currentId = id;
    const doc = await db.collection('incidents').doc(id).get();
    const d = doc.data();
    document.getElementById('iDate').value = d.incidentDate || "";
    document.getElementById('iTeam').value = d.team || "";
    document.getElementById('iDescription').value = d.description || "";
    document.getElementById('iNotes').value = d.notes || "";
    document.getElementById('btnArchiveIncident').style.display = 'inline-flex';
    document.getElementById('btnDeleteIncident').style.display = 'inline-flex';
    document.getElementById('btnPromote').style.display = 'inline-flex';
    document.getElementById('incidentModal').style.display = 'flex';
}

async function saveIncident() {
    const data = {
        incidentDate: document.getElementById('iDate').value,
        team: document.getElementById('iTeam').value,
        description: document.getElementById('iDescription').value,
        notes: document.getElementById('iNotes').value,
        status: 'active',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    if(currentId) {
        await db.collection('incidents').doc(currentId).update(data);
        auditLog('Updated Incident', currentId, 'incident');
    } else {
        const res = await db.collection('incidents').add(data);
        auditLog('Created Incident', res.id, 'incident');
    }
    closeModals();
}

async function archiveCurrentIncident() {
    if(!confirm("Archive this incident?")) return;
    await db.collection('incidents').doc(currentId).update({ status: 'archived' });
    auditLog('Archived Incident', currentId, 'incident');
    closeModals();
}

async function deleteCurrentIncident() {
    if(!confirm("CRITICAL: Delete this record forever? This cannot be undone.")) return;
    if(!confirm("Are you absolutely sure?")) return;
    await db.collection('incidents').doc(currentId).delete();
    auditLog('DELETED Incident', currentId, 'incident');
    closeModals();
}

async function promoteToInvestigation() {
    const doc = await db.collection('incidents').doc(currentId).get();
    const d = doc.data();
    const res = await db.collection('investigations').add({
        team: d.team, incidentDate: d.incidentDate, summary: d.description, status: 'active', timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection('incidents').doc(currentId).update({ status: 'archived' });
    auditLog('Promoted to Investigation', res.id, 'investigation');
    closeModals();
    switchTab('investigations');
}

/* ================= INVESTIGATION LOGIC ================= */
db.collection('investigations').orderBy('timestamp', 'desc').onSnapshot(snap => {
    const list = document.getElementById('section-investigations');
    list.innerHTML = '';
    snap.forEach(doc => {
        const d = doc.data();
        if (d.status === 'archived') return;
        const card = document.createElement('div');
        card.className = 'card'; card.style.borderTopColor = 'var(--primary)';
        card.innerHTML = `<span class="badge" style="background:var(--primary); color:white;">ACTIVE CASE</span><h4>${d.team}</h4><p>${(d.summary || '').substring(0, 80)}...</p><button class="btn btn-primary" onclick="editInvestigation('${doc.id}')">View Case File</button>`;
        list.appendChild(card);
    });
});

async function editInvestigation(id) {
    currentInvId = id;
    const doc = await db.collection('investigations').doc(id).get();
    const d = doc.data();
    document.getElementById('vSummary').value = d.summary || "";
    document.getElementById('vPeople').value = d.people || "";
    document.getElementById('vFindings').value = d.findings || "";
    document.getElementById('investigationModal').style.display = 'flex';
}

async function saveInvestigation() {
    await db.collection('investigations').doc(currentInvId).update({
        summary: document.getElementById('vSummary').value, people: document.getElementById('vPeople').value, findings: document.getElementById('vFindings').value
    });
    auditLog('Updated Investigation', currentInvId, 'investigation');
    closeModals();
}

async function archiveCurrentInvestigation() {
    if(!confirm("Archive this case?")) return;
    await db.collection('investigations').doc(currentInvId).update({ status: 'archived' });
    auditLog('Archived Investigation', currentInvId, 'investigation');
    closeModals();
}

async function deleteCurrentInvestigation() {
    if(!confirm("CRITICAL: Delete this case file forever?")) return;
    await db.collection('investigations').doc(currentInvId).delete();
    auditLog('DELETED Investigation', currentInvId, 'investigation');
    closeModals();
}

/* ================= ARCHIVE LOGIC ================= */
async function loadArchive() {
    const list = document.getElementById('section-archive'); list.innerHTML = 'Loading...';
    const [incSnap, invSnap] = await Promise.all([
        db.collection('incidents').where('status', '==', 'archived').get(),
        db.collection('investigations').where('status', '==', 'archived').get()
    ]);
    list.innerHTML = '';
    incSnap.forEach(doc => renderArchive(doc.data(), 'Incident', list));
    invSnap.forEach(doc => renderArchive(doc.data(), 'Investigation', list));
}

function renderArchive(d, type, container) {
    const card = document.createElement('div');
    card.className = 'card archived';
    card.innerHTML = `<span class="badge" style="background:#666; color:white;">${type}</span><h4>${d.team}</h4><small>${d.incidentDate}</small>`;
    container.appendChild(card);
}
</script>
</body>
</html>
