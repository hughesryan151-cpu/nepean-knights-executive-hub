<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nepean Knights – Executive Hub</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #E41F26;
            --primary-hover: #b3181d;
            --secondary: #FFD200;
            --dark: #1a1a1a;
            --light-bg: #f4f7f6;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 8px;
            --success: #28a745;
            --warning: #f39c12;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--light-bg);
            color: var(--dark);
        }

        header {
            background: var(--dark);
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--primary);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Buttons */
        .btn {
            cursor: pointer;
            border: none;
            border-radius: var(--radius);
            padding: 10px 18px;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn-success { background: var(--success); color: white; }
        .btn-archive { background: #6c757d; color: white; }

        /* Tabs */
        .tabs-nav { margin: 20px 0; display: flex; gap: 20px; border-bottom: 1px solid #ddd; }
        .tab {
            padding: 12px 10px;
            cursor: pointer;
            font-weight: bold;
            color: #777;
            position: relative;
        }
        .tab.active { color: var(--primary); }
        .tab.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--primary);
        }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--secondary);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .card.archived { opacity: 0.7; border-top-color: #6c757d; }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            background: var(--white);
            width: 100%;
            max-width: 950px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            border-radius: var(--radius);
        }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .span-2 { grid-column: span 2; }
        label { font-weight: bold; font-size: 0.85rem; color: #444; margin-bottom: 5px; display: block; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
        
        .hidden { display: none; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>

<body>

<header>
    <div>
        <h2 style="margin:0">Nepean Knights</h2>
        <span style="color:var(--secondary); font-size: 0.8rem; font-weight: bold;">EXECUTIVE MANAGEMENT SYSTEM</span>
    </div>
    <div style="display:flex; align-items:center; gap:15px;">
        <span id="userDisplay" style="font-size: 0.9rem; opacity: 0.8;"></span>
        <button class="btn btn-outline" style="color:white; border-color:rgba(255,255,255,0.3)" id="btnLogout">Logout</button>
    </div>
</header>

<div class="container">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div class="tabs-nav">
            <div class="tab active" data-tab="incidents">Active Incidents</div>
            <div class="tab" data-tab="investigations">Investigations</div>
            <div class="tab" data-tab="archive">Archive</div>
        </div>
        <button class="btn btn-primary" id="btnNewIncident">＋ Log Incident</button>
    </div>

    <div id="incidentList" class="grid"></div>
    <div id="investigationList" class="grid hidden"></div>
    <div id="archiveList" class="grid hidden"></div>
</div>

<div class="modal" id="incidentModal">
    <div class="modal-content">
        <h2>Incident Intake</h2>
        <div class="form-grid">
            <div><label>Date</label><input type="date" id="iDate"></div>
            <div><label>Team/Division</label><input type="text" id="iTeam"></div>
            <div class="span-2"><label>Location</label><input type="text" id="iArena"></div>
            <div class="span-2"><label>Initial Description</label><textarea id="iDescription"></textarea></div>
            <div class="span-2"><label>Internal Notes</label><textarea id="iNotes"></textarea></div>
        </div>
        <div style="margin-top:25px; display:flex; justify-content: flex-end; gap:10px;">
            <button class="btn btn-outline" onclick="closeModals()">Cancel</button>
            <button class="btn btn-primary" id="btnSaveIncident">Save Incident</button>
            <button class="btn btn-success" id="btnPromote">Promote to Investigation</button>
        </div>
    </div>
</div>

<div class="modal" id="investigationModal">
    <div class="modal-content">
        <div style="display:flex; justify-content: space-between;">
            <h2>Investigation File</h2>
            <div id="invStatusBadge" class="status-badge" style="background:var(--secondary)">ACTIVE</div>
        </div>
        <div class="form-grid">
            <div class="span-2"><h4 style="border-bottom: 2px solid var(--primary);">Case Information</h4></div>
            <textarea id="vPlayers" placeholder="Players Involved"></textarea>
            <textarea id="vCoaches" placeholder="Staff Involved"></textarea>
            <textarea id="vEvidence" class="span-2" placeholder="Evidence Links/Logs"></textarea>
            
            <div class="span-2"><h4 style="border-bottom: 2px solid var(--primary);">Findings & Ruling</h4></div>
            <textarea id="vFindings" placeholder="Findings of Fact"></textarea>
            <textarea id="vFinalOutcome" placeholder="Final Decision/Sanction"></textarea>
        </div>
        <div style="margin-top:25px; display:flex; justify-content: flex-end; gap:10px;">
            <button class="btn btn-outline" onclick="closeModals()">Close View</button>
            <button class="btn btn-archive" id="btnArchiveInv">Archive Case</button>
            <button class="btn btn-primary" id="btnSaveInvestigation">Save Progress</button>
        </div>
    </div>
</div>

<script>
/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
    apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
    authDomain: "nepean-knights-executive-hub.firebaseapp.com",
    projectId: "nepean-knights-executive-hub"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentId = null;
let currentInvestigationId = null;
let currentUser = null;

/* ================= AUTH & AUDIT ================= */
auth.onAuthStateChanged(user => {
    if (!user) window.location.href = "index.html";
    currentUser = user;
    document.getElementById('userDisplay').innerText = user.email;
});

async function logAction(action, docId, type) {
    await db.collection('audit_logs').add({
        user: currentUser.email,
        action: action,
        docId: docId,
        type: type,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
}

/* ================= NAVIGATION ================= */
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.dataset.tab;
        document.getElementById('incidentList').classList.toggle('hidden', target !== 'incidents');
        document.getElementById('investigationList').classList.toggle('hidden', target !== 'investigations');
        document.getElementById('archiveList').classList.toggle('hidden', target !== 'archive');
    });
});

function closeModals() {
    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
}

/* ================= CORE LOGIC ================= */

// 1. INCIDENTS
db.collection('incidents').where('archived', '==', false).orderBy('timestamp', 'desc').onSnapshot(snap => {
    const list = document.getElementById('incidentList');
    list.innerHTML = '';
    snap.forEach(doc => {
        const d = doc.data();
        const card = createCard(d.team, d.incidentDate, d.description, () => openIncident(doc.id, d));
        list.appendChild(card);
    });
});

function createCard(title, subtitle, text, onClick) {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<div><small>${subtitle}</small><h4>${title}</h4><p>${text?.substring(0,80)}...</p></div><button class="btn btn-outline">Open</button>`;
    div.querySelector('button').onclick = onClick;
    return div;
}

function openIncident(id, d) {
    currentId = id;
    document.getElementById('iDate').value = d.incidentDate || '';
    document.getElementById('iTeam').value = d.team || '';
    document.getElementById('iArena').value = d.arena || '';
    document.getElementById('iDescription').value = d.description || '';
    document.getElementById('iNotes').value = d.notes || '';
    document.getElementById('incidentModal').style.display = 'flex';
}

document.getElementById('btnSaveIncident').onclick = async () => {
    const data = {
        incidentDate: document.getElementById('iDate').value,
        team: document.getElementById('iTeam').value,
        arena: document.getElementById('iArena').value,
        description: document.getElementById('iDescription').value,
        notes: document.getElementById('iNotes').value,
        archived: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    if(currentId) {
        await db.collection('incidents').doc(currentId).update(data);
        logAction('Updated Incident', currentId, 'incident');
    } else {
        const ref = await db.collection('incidents').add(data);
        logAction('Created Incident', ref.id, 'incident');
    }
    closeModals();
};

// 2. INVESTIGATIONS
db.collection('investigations').where('status', '==', 'open').onSnapshot(snap => {
    const list = document.getElementById('investigationList');
    list.innerHTML = '';
    snap.forEach(doc => {
        const d = doc.data();
        const card = createCard(d.team, 'ACTIVE FILE', d.findings || 'No findings yet', () => openInvestigation(doc.id, d));
        list.appendChild(card);
    });
});

// 3. ARCHIVE
db.collection('investigations').where('status', '==', 'archived').onSnapshot(snap => {
    const list = document.getElementById('archiveList');
    list.innerHTML = '';
    snap.forEach(doc => {
        const d = doc.data();
        const card = createCard(d.team, 'ARCHIVED', d.finalOutcome, () => openInvestigation(doc.id, d));
        card.classList.add('archived');
        list.appendChild(card);
    });
});

function openInvestigation(id, d) {
    currentInvestigationId = id;
    document.getElementById('vPlayers').value = d.players || '';
    document.getElementById('vCoaches').value = d.coaches || '';
    document.getElementById('vEvidence').value = d.evidence || '';
    document.getElementById('vFindings').value = d.findings || '';
    document.getElementById('vFinalOutcome').value = d.finalOutcome || '';
    
    const badge = document.getElementById('invStatusBadge');
    badge.innerText = d.status.toUpperCase();
    badge.style.background = d.status === 'archived' ? '#6c757d' : var(--secondary);
    
    document.getElementById('investigationModal').style.display = 'flex';
}

document.getElementById('btnSaveInvestigation').onclick = async () => {
    const data = {
        players: document.getElementById('vPlayers').value,
        coaches: document.getElementById('vCoaches').value,
        evidence: document.getElementById('vEvidence').value,
        findings: document.getElementById('vFindings').value,
        finalOutcome: document.getElementById('vFinalOutcome').value,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('investigations').doc(currentInvestigationId).update(data);
    logAction('Updated Investigation', currentInvestigationId, 'investigation');
    closeModals();
};

document.getElementById('btnArchiveInv').onclick = async () => {
    if(!confirm("Archive this case? It will be moved to the Archive tab.")) return;
    await db.collection('investigations').doc(currentInvestigationId).update({ status: 'archived' });
    logAction('Archived Investigation', currentInvestigationId, 'investigation');
    closeModals();
};

document.getElementById('btnPromote').onclick = async () => {
    const snap = await db.collection('incidents').doc(currentId).get();
    const d = snap.data();
    const invRef = await db.collection('investigations').add({
        team: d.team, incidentDate: d.incidentDate, status: 'open', timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection('incidents').doc(currentId).update({ archived: true });
    logAction('Promoted to Investigation', invRef.id, 'investigation');
    closeModals();
};

document.getElementById('btnLogout').onclick = () => auth.signOut();
document.getElementById('btnNewIncident').onclick = () => { currentId = null; openIncident(null, {}); };
</script>
</body>
</html>
