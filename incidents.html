<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nepean Knights – Incident & Investigation Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ================== THEME ================== */
:root{
  --primary:#E41F26;
  --secondary:#FFD200;
  --dark:#222;
  --bg:#f4f5f7;
}
*{box-sizing:border-box}

/* ================== LAYOUT ================== */
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:#000;
}

header{
  background:var(--primary);
  color:var(--secondary);
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button{
  cursor:pointer;
  border:none;
  border-radius:5px;
  padding:8px 14px;
  font-weight:bold;
}

.primary{background:var(--primary);color:var(--secondary)}
.secondary{background:#ddd}

.container{padding:20px}

.tabs{
  margin-top:10px;
}
.tab{
  display:inline-block;
  padding:10px 15px;
  margin-right:5px;
  background:var(--secondary);
  border-radius:5px;
}
.tab.active{
  background:var(--primary);
  color:var(--secondary);
}

.card{
  background:#fff;
  border-radius:6px;
  padding:15px;
  margin-top:12px;
  box-shadow:0 2px 5px rgba(0,0,0,.1);
}

.hidden{display:none}

/* ================== MODALS ================== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal-content{
  background:#fff;
  width:95%;
  max-width:1000px;
  max-height:92vh;
  overflow-y:auto;
  padding:20px;
  border-radius:8px;
}

input,textarea{
  width:100%;
  padding:8px;
  margin-bottom:10px;
}
textarea{min-height:120px}

/* ================== SECTIONS ================== */
.section{
  margin-top:20px;
}
.section h3{
  margin:0 0 10px;
  padding-bottom:5px;
  border-bottom:2px solid var(--primary);
}
</style>
</head>

<body>

<header>
  <h2>Incident & Investigation Dashboard</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">
  <button class="primary" onclick="openIncident()">➕ Create Incident</button>

  <div class="tabs">
    <span class="tab active" id="tabIncidents" onclick="switchTab('incidents')">Incidents</span>
    <span class="tab" id="tabInvestigations" onclick="switchTab('investigations')">Investigations</span>
  </div>

  <div id="incidentList"></div>
  <div id="investigationList" class="hidden"></div>
</div>

<!-- ================= INCIDENT MODAL ================= -->
<div class="modal" id="incidentModal">
<div class="modal-content">
<button class="secondary" onclick="closeIncident()">← Back to Dashboard</button>

<h2>Incident Report</h2>

<label>Date</label>
<input type="date" id="iDate">

<label>Team</label>
<input id="iTeam">

<label>Arena</label>
<input id="iArena">

<label>Incident Description</label>
<textarea id="iDescription"></textarea>

<label>Internal Notes</label>
<textarea id="iNotes"></textarea>

<button class="primary" onclick="saveIncident()">Save Incident</button>
<button onclick="sendToInvestigation()">Send to Investigation</button>
</div>
</div>

<!-- ================= INVESTIGATION MODAL ================= -->
<div class="modal" id="investigationModal">
<div class="modal-content">
<button class="secondary" onclick="closeInvestigation()">← Back to Dashboard</button>

<h2>Formal Investigation File</h2>

<div class="section">
<h3>1. Incident Overview</h3>
<input type="date" id="vDate">
<input id="vTeam" placeholder="Team">
<input id="vArena" placeholder="Arena">
<textarea id="vDescription" placeholder="Incident summary"></textarea>
</div>

<div class="section">
<h3>2. Individuals Involved</h3>
<textarea id="vPlayers" placeholder="Players (Name, DOB, #)"></textarea>
<textarea id="vCoaches" placeholder="Coaches / Staff (Name, Role, DOB)"></textarea>
<textarea id="vWitnesses" placeholder="Witnesses (Name, Contact Info)"></textarea>
</div>

<div class="section">
<h3>3. Evidence & Interviews</h3>
<textarea id="vInvestigatorNotes" placeholder="Investigator notes"></textarea>
<textarea id="vInterviewNotes" placeholder="Interview summaries"></textarea>
<textarea id="vWitnessStatements" placeholder="Witness statements"></textarea>
<textarea id="vEvidence" placeholder="Evidence (video, photos, reports)"></textarea>
</div>

<div class="section">
<h3>4. History & Findings</h3>
<textarea id="vPriorIncidents" placeholder="Prior incidents"></textarea>
<textarea id="vPriorPunishments" placeholder="Prior punishments"></textarea>
<textarea id="vFindings" placeholder="Findings of fact"></textarea>
</div>

<div class="section">
<h3>5. Outcome</h3>
<textarea id="vRecommendedOutcome" placeholder="Recommended outcome"></textarea>
<textarea id="vFinalOutcome" placeholder="Final decision"></textarea>
</div>

<button class="primary" onclick="saveInvestigation()">Save Investigation</button>
</div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
  authDomain:"nepean-knights-executive-hub.firebaseapp.com",
  projectId:"nepean-knights-executive-hub"
});

const auth=firebase.auth();
const db=firebase.firestore();

let incidentId=null;
let investigationId=null;

/* ================= AUTH ================= */
auth.onAuthStateChanged(u=>{
  if(!u) window.location.href="index.html";
});
function logout(){auth.signOut()}

/* ================= TABS ================= */
function switchTab(tab){
  tabIncidents.classList.toggle('active',tab==='incidents');
  tabInvestigations.classList.toggle('active',tab==='investigations');
  incidentList.classList.toggle('hidden',tab!=='incidents');
  investigationList.classList.toggle('hidden',tab!=='investigations');
}

/* ================= INCIDENTS ================= */
function openIncident(data=null){
  incidentModal.style.display='flex';
  incidentId=data?.id||null;
  iDate.value=data?.incidentDate||'';
  iTeam.value=data?.team||'';
  iArena.value=data?.arena||'';
  iDescription.value=data?.description||'';
  iNotes.value=data?.notes||'';
}
function closeIncident(){incidentModal.style.display='none'}

function saveIncident(){
  const data={
    incidentDate:iDate.value,
    team:iTeam.value,
    arena:iArena.value,
    description:iDescription.value,
    notes:iNotes.value,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  };
  if(incidentId){
    db.collection('incidents').doc(incidentId).update(data);
  }else{
    db.collection('incidents').add(data);
  }
  closeIncident();
}

function sendToInvestigation(){
  if(!incidentId){alert("Save the incident first.");return}
  if(!confirm("Create a formal investigation?"))return;

  db.collection('incidents').doc(incidentId).get().then(doc=>{
    const d=doc.data();
    db.collection('investigations').add({
      incidentDate:d.incidentDate,
      team:d.team,
      arena:d.arena,
      description:d.description,
      players:'',coaches:'',witnesses:'',
      investigatorNotes:'',interviewNotes:'',
      witnessStatements:'',evidence:'',
      priorIncidents:'',priorPunishments:'',
      findings:'',
      recommendedOutcome:'',finalOutcome:'',
      status:'open',
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Investigation created.");
  });
  closeIncident();
}

/* ================= INVESTIGATIONS ================= */
function openInvestigation(d,id){
  investigationId=id;
  investigationModal.style.display='flex';
  vDate.value=d.incidentDate||'';
  vTeam.value=d.team||'';
  vArena.value=d.arena||'';
  vDescription.value=d.description||'';
  vPlayers.value=d.players||'';
  vCoaches.value=d.coaches||'';
  vWitnesses.value=d.witnesses||'';
  vInvestigatorNotes.value=d.investigatorNotes||'';
  vInterviewNotes.value=d.interviewNotes||'';
  vWitnessStatements.value=d.witnessStatements||'';
  vEvidence.value=d.evidence||'';
  vPriorIncidents.value=d.priorIncidents||'';
  vPriorPunishments.value=d.priorPunishments||'';
  vFindings.value=d.findings||'';
  vRecommendedOutcome.value=d.recommendedOutcome||'';
  vFinalOutcome.value=d.finalOutcome||'';
}
function closeInvestigation(){investigationModal.style.display='none'}

function saveInvestigation(){
  db.collection('investigations').doc(investigationId).update({
    players:vPlayers.value,
    coaches:vCoaches.value,
    witnesses:vWitnesses.value,
    investigatorNotes:vInvestigatorNotes.value,
    interviewNotes:vInterviewNotes.value,
    witnessStatements:vWitnessStatements.value,
    evidence:vEvidence.value,
    priorIncidents:vPriorIncidents.value,
    priorPunishments:vPriorPunishments.value,
    findings:vFindings.value,
    recommendedOutcome:vRecommendedOutcome.value,
    finalOutcome:vFinalOutcome.value
  });
  closeInvestigation();
}

/* ================= LOAD DATA ================= */
db.collection('incidents').orderBy('timestamp','desc').onSnapshot(s=>{
  incidentList.innerHTML='';
  s.forEach(doc=>{
    const d=doc.data();
    incidentList.innerHTML+=`
      <div class="card">
        <b>${d.team||'Incident'}</b><br>
        ${d.description||''}<br>
        <button onclick='openIncident(${JSON.stringify({...d,id:doc.id})})'>Open</button>
      </div>`;
  });
});

db.collection('investigations').orderBy('timestamp','desc').onSnapshot(s=>{
  investigationList.innerHTML='';
  s.forEach(doc=>{
    const d=doc.data();
    investigationList.innerHTML+=`
      <div class="card">
        <b>${d.team||'Investigation'}</b><br>
        ${d.description||''}<br>
        <button onclick='openInvestigation(${JSON.stringify(d)},"${doc.id}")'>Open Investigation</button>
      </div>`;
  });
});
</script>

</body>
</html>


