<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Investigations â€“ Nepean Knights</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
body{font-family:Arial,sans-serif;margin:0;background:linear-gradient(135deg,#FFD200,#E41F26);}
header{display:flex;align-items:center;justify-content:space-between;background:#E41F26;color:#FFD200;padding:10px 20px;}
header img{height:50px;}
header button{background:#FFD200;color:#000;border:none;padding:10px 15px;border-radius:6px;font-weight:bold;cursor:pointer;}
header button:hover{opacity:.9;}
main{padding:20px;}
.card{background:#FFF2CC;border-radius:10px;padding:20px;margin:20px auto;max-width:1000px;box-shadow:0 2px 5px rgba(0,0,0,.2);}
input,textarea,select{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
textarea{resize:vertical;}
button{background:#FFD200;color:#000;padding:10px 15px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;}
button:hover{opacity:.9;}
h2{color:#E41F26;text-align:center;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ccc;padding:10px;text-align:left;}
th{background:#FFD200;color:#000;}
tr:nth-child(even){background:#fff8dc;}
.add-btn{margin:5px 0;background:#E41F26;color:#FFD200;}
.filter-container{margin-top:20px;}
.filter-container input, .filter-container select{width:auto;display:inline-block;margin-right:10px;}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;">
    <img src="nepean-knights-logo.png" alt="Logo">
    <img src="knights-banner-updated.png" alt="Banner">
  </div>
  <button onclick="logout()">Logout</button>
</header>

<main>
  <div class="card">
    <h2>Investigations</h2>
    <button onclick="showForm()">Create New Investigation</button>

    <!-- Filter Section -->
    <div class="filter-container">
      <input type="text" id="filterPlayer" placeholder="Filter by Player">
      <input type="text" id="filterTeam" placeholder="Filter by Team">
      <select id="filterStatus">
        <option value="">All Status</option>
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Closed">Closed</option>
      </select>
      <button onclick="applyFilter()">Filter</button>
    </div>

    <!-- Investigation Form -->
    <section id="investigationForm" style="display:none;margin-top:20px;">
      <input type="text" id="playerName" placeholder="Player Name">
      <input type="text" id="teamName" placeholder="Team Name">
      <select id="status">
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Closed">Closed</option>
      </select>

      <h3>Timeline Events</h3>
      <div id="timelineContainer"></div>
      <button type="button" class="add-btn" onclick="addTimeline()">Add Timeline Event</button>

      <h3>Interviews</h3>
      <div id="interviewContainer"></div>
      <button type="button" class="add-btn" onclick="addInterview()">Add Interview</button>

      <h3>Expert Comments</h3>
      <div id="expertContainer"></div>
      <button type="button" class="add-btn" onclick="addExpert()">Add Expert Comment</button>

      <h3>Evidence Uploads</h3>
      <input type="file" id="evidenceFiles" multiple>

      <textarea id="finalNotes" placeholder="Final Notes"></textarea>
      <input type="text" id="recommendedPunishment" placeholder="Recommended Punishment">
      <input type="text" id="givenPunishment" placeholder="Given Punishment">

      <button onclick="saveInvestigation()">Save Investigation</button>
    </section>

    <h3 style="margin-top:30px;">Existing Investigations</h3>
    <table>
      <thead>
        <tr>
          <th>Incident #</th>
          <th>Player</th>
          <th>Team</th>
          <th>Status</th>
          <th>Actions</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="investigationList"></tbody>
    </table>
  </div>

  <button onclick="window.location.href='dashboard.html'" style="margin:20px auto; display:block;">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
  </button>
</main>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
  authDomain:"nepean-knights-executive-hub.firebaseapp.com",
  projectId:"nepean-knights-executive-hub",
  storageBucket:"nepean-knights-executive-hub.firebasestorage.app",
  messagingSenderId:"103399385512",
  appId:"1:103399385512:web:bbd8ac65b5c8be5332159d"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore(),storage=firebase.storage();
auth.onAuthStateChanged(user=>{if(!user)window.location.href="index.html"});
function logout(){auth.signOut().then(()=>window.location.href="index.html")}

function showForm(){document.getElementById('investigationForm').style.display='block';}

// Dynamic Form Sections
function addTimeline(){
  const div=document.createElement('div');
  div.innerHTML=`<input type="time" class="timelineTime"><input type="text" class="timelineEvent" placeholder="Event Description"><input type="text" class="timelineWitness" placeholder="Witness/Source">`;
  document.getElementById('timelineContainer').appendChild(div);
}
function addInterview(){
  const div=document.createElement('div');
  div.innerHTML=`<input type="text" class="interviewName" placeholder="Name"><input type="text" class="interviewRole" placeholder="Role"><textarea class="interviewSummary" placeholder="Summary / Notes"></textarea>`;
  document.getElementById('interviewContainer').appendChild(div);
}
function addExpert(){
  const div=document.createElement('div');
  div.innerHTML=`<input type="text" class="expertName" placeholder="Expert Name"><input type="text" class="expertRole" placeholder="Role/Qualification"><textarea class="expertComment" placeholder="Comment"></textarea>`;
  document.getElementById('expertContainer').appendChild(div);
}

// Auto-generate Incident Number
async function generateIncidentNumber() {
  const now=new Date();
  const year=now.getFullYear().toString().slice(-2);
  const month=String(now.getMonth()+1).padStart(2,'0');
  const snapshot=await db.collection('investigations').where('month','==',month).where('year','==',year).get();
  const sequence=(snapshot.size+1).toString().padStart(3,'0');
  return {incidentNumber:`${year}-${month}-${sequence}`,year,month};
}

// Save or Update Investigation
async function saveInvestigation(){
  const playerName=document.getElementById('playerName').value.trim();
  const teamName=document.getElementById('teamName').value.trim();
  const status=document.getElementById('status').value;
  const finalNotes=document.getElementById('finalNotes').value.trim();
  const recommendedPunishment=document.getElementById('recommendedPunishment').value.trim();
  const givenPunishment=document.getElementById('givenPunishment').value.trim();
  if(!playerName||!teamName) return alert("Please fill Player Name and Team Name.");

  const timeline=Array.from(document.querySelectorAll('#timelineContainer>div')).map(div=>({
    time:div.querySelector('.timelineTime').value,
    event:div.querySelector('.timelineEvent').value,
    witness:div.querySelector('.timelineWitness').value
  }));
  const interviews=Array.from(document.querySelectorAll('#interviewContainer>div')).map(div=>({
    name:div.querySelector('.interviewName').value,
    role:div.querySelector('.interviewRole').value,
    summary:div.querySelector('.interviewSummary').value
  }));
  const expertComments=Array.from(document.querySelectorAll('#expertContainer>div')).map(div=>({
    name:div.querySelector('.expertName').value,
    role:div.querySelector('.expertRole').value,
    comment:div.querySelector('.expertComment').value
  }));

  const files=document.getElementById('evidenceFiles').files;
  const evidence=[];
  for(let file of files){
    const ref=storage.ref().child(`evidence/${Date.now()}_${file.name}`);
    await ref.put(file);
    const url=await ref.getDownloadURL();
    evidence.push({name:file.name,url});
  }

  const editId=document.getElementById('investigationForm').dataset.editId;
  if(editId){
    await db.collection('investigations').doc(editId).update({
      playerName, teamName, status, finalNotes, recommendedPunishment, givenPunishment,
      timeline, interviews, expertComments,
      evidence: firebase.firestore.FieldValue.arrayUnion(...evidence)
    });
    alert("Investigation updated!");
    delete document.getElementById('investigationForm').dataset.editId;
  }else{
    const {incidentNumber,year,month}=await generateIncidentNumber();
    await db.collection('investigations').add({
      incidentNumber,playerName,teamName,status,year,month,finalNotes,recommendedPunishment,givenPunishment,
      timeline,interviews,expertComments,evidence,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("Investigation saved!");
  }

  document.getElementById('investigationForm').reset();
  document.getElementById('timelineContainer').innerHTML='';
  document.getElementById('interviewContainer').innerHTML='';
  document.getElementById('expertContainer').innerHTML='';
  document.getElementById('investigationForm').style.display='none';
  loadInvestigations();
}

// Load Investigations
function loadInvestigations(){
  const tbody=document.getElementById('investigationList');
  tbody.innerHTML='';
  db.collection('investigations').orderBy('timestamp','desc').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const d=doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${d.incidentNumber}</td>
        <td>${d.playerName}</td>
        <td>${d.teamName}</td>
        <td>${d.status}</td>
        <td>
          <button onclick="editInvestigation('${doc.id}')">Edit</button>
          <button onclick="printInvestigation('${doc.id}')">Print</button>
          <button onclick="deleteInvestigation('${doc.id}')">Delete</button>
        </td>
        <td>${d.timestamp?d.timestamp.toDate().toLocaleString():''}</td>
      `;
      tbody.appendChild(tr);
    });
  });
}
loadInvestigations();

// Edit Investigation
async function editInvestigation(docId){
  const doc=await db.collection('investigations').doc(docId).get();
  if(!doc.exists) return alert("Investigation not found");
  const d=doc.data();
  document.getElementById('playerName').value=d.playerName;
  document.getElementById('teamName').value=d.teamName;
  document.getElementById('status').value=d.status;
  document.getElementById('finalNotes').value=d.finalNotes||'';
  document.getElementById('recommendedPunishment').value=d.recommendedPunishment||'';
  document.getElementById('givenPunishment').value=d.givenPunishment||'';

  const timelineContainer=document.getElementById('timelineContainer'); timelineContainer.innerHTML='';
  d.timeline.forEach(ev=>{
    const div=document.createElement('div');
    div.innerHTML=`<input type="time" class="timelineTime" value="${ev.time}"><input type="text" class="timelineEvent" value="${ev.event}"><input type="text" class="timelineWitness" value="${ev.witness}">`;
    timelineContainer.appendChild(div);
  });

  const interviewContainer=document.getElementById('interviewContainer'); interviewContainer.innerHTML='';
  d.interviews.forEach(i=>{
    const div=document.createElement('div');
    div.innerHTML=`<input type="text" class="interviewName" value="${i.name}"><input type="text" class="interviewRole" value="${i.role}"><textarea class="interviewSummary">${i.summary}</textarea>`;
    interviewContainer.appendChild(div);
  });

  const expertContainer=document.getElementById('expertContainer'); expertContainer.innerHTML='';
  d.expertComments.forEach(e=>{
    const div=document.createElement('div');
    div.innerHTML=`<input type="text" class="expertName" value="${e.name}"><input type="text" class="expertRole" value="${e.role}"><textarea class="expertComment">${e.comment}</textarea>`;
    expertContainer.appendChild(div);
  });

  document.getElementById('investigationForm').dataset.editId=docId;
  document.getElementById('investigationForm').style.display='block';
}

// Delete Investigation
function deleteInvestigation(docId){
  if(confirm("Are you sure you want to delete this investigation? This cannot be undone.")){
    db.collection('investigations').doc(docId).delete().then(()=>{
      alert("Investigation deleted successfully.");
      loadInvestigations();
    }).catch(err=>{
      console.error(err);
      alert("Error deleting investigation.");
    });
  }
}

// Apply Filter
function applyFilter(){
  const playerFilter=document.getElementById('filterPlayer').value.toLowerCase();
  const teamFilter=document.getElementById('filterTeam').value.toLowerCase();
  const statusFilter=document.getElementById('filterStatus').value;

  const tbody=document.getElementById('investigationList'); tbody.innerHTML='';

  db.collection('investigations').orderBy('timestamp','desc').get().then(snapshot=>{
    snapshot.forEach(doc=>{
      const d=doc.data();
      if(
        (!playerFilter || d.playerName.toLowerCase().includes(playerFilter)) &&
        (!teamFilter || d.teamName.toLowerCase().includes(teamFilter)) &&
        (!statusFilter || d.status===statusFilter)
      ){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${d.incidentNumber}</td>
          <td>${d.playerName}</td>
          <td>${d.teamName}</td>
          <td>${d.status}</td>
          <td>
            <button onclick="editInvestigation('${doc.id}')">Edit</button>
            <button onclick="printInvestigation('${doc.id}')">Print</button>
            <button onclick="deleteInvestigation('${doc.id}')">Delete</button>
          </td>
          <td>${d.timestamp?d.timestamp.toDate().toLocaleString():''}</td>
        `;
        tbody.appendChild(tr);
      }
    });
  });
}

// Print Investigation
function printInvestigation(docId){
  db.collection('investigations').doc(docId).get().then(doc=>{
    if(!doc.exists) return alert("Investigation not found");
    const d=doc.data();
    const win=window.open('','','width=900,height=700');
    win.document.write(`<html><head><title>Investigation ${d.incidentNumber}</title></head><body>`);
    win.document.write(`<h1>Investigation: ${d.incidentNumber}</h1>`);
    win.document.write(`<h2>Player: ${d.playerName}</h2>`);
    win.document.write(`<h2>Team: ${d.teamName}</h2>`);
    win.document.write(`<h3>Status: ${d.status}</h3>`);

    win.document.write(`<h3>Timeline</h3>`);
    if(d.timeline.length===0) win.document.write('<p>No timeline events.</p>');
    d.timeline.forEach(ev=>{win.document.write(`<p><strong>${ev.time}</strong>: ${ev.event} (Witness: ${ev.witness})</p>`);});

    win.document.write(`<h3>Interviews</h3>`);
    if(d.interviews.length===0) win.document.write('<p>No interviews.</p>');
    d.interviews.forEach(i=>{win.document.write(`<p><strong>${i.name} (${i.role})</strong>: ${i.summary}</p>`);});

    win.document.write(`<h3>Expert Comments</h3>`);
    if(d.expertComments.length===0) win.document.write('<p>No expert comments.</p>');
    d.expertComments.forEach(e=>{win.document.write(`<p><strong>${e.name} (${e.role})</strong>: ${e.comment}</p>`);});

    win.document.write(`<h3>Evidence</h3>`);
    if(d.evidence.length===0) win.document.write('<p>No files uploaded.</p>');
    d.evidence.forEach(ev=>{win.document.write(`<p><a href="${ev.url}" target="_blank">${ev.name}</a></p>`);});

    win.document.write(`<h3>Final Notes</h3><p>${d.finalNotes||''}</p>`);
    win.document.write(`<h3>Recommended Punishment</h3><p>${d.recommendedPunishment||''}</p>`);
    win.document.write(`<h3>Given Punishment</h3><p>${d.givenPunishment||''}</p>`);

    win.document.write('</body></html>');
    win.document.close();
    win.print();
  });
}
</script>

</body>
</html>
