<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Arena Maintenance â€“ Nepean Knights</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
:root {
  --primary-color:#E41F26;
  --secondary-color:#FFD200;
  --accent-color:#000;
  --bg-color:#FFE680;
  --card-bg:#FFF2CC;
  --ok-color:#4CAF50;
  --pending-color:#FF6B6B;
  --inprogress-color:#FF9800;
  --modal-bg:#fff;
}

body { font-family: Arial,sans-serif; margin:0; background:linear-gradient(135deg,#FFD200,#E41F26);}
header { display:flex; align-items:center; justify-content:space-between; background-color:var(--primary-color); color:var(--secondary-color); padding:10px 20px;}
header img.logo{height:50px;margin-right:10px;}
header img.banner{height:50px;}
header button{background-color:var(--secondary-color); color:var(--accent-color); border:none; padding:10px 15px; border-radius:6px; cursor:pointer; font-weight:bold;}
header button:hover{opacity:0.9;}

h2,h3{color:var(--primary-color); text-align:center;}

.arena-grid{display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:20px; padding:20px;}
.arena-tile{background-color:var(--card-bg); border-radius:15px; padding:20px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s; text-align:center; position:relative;}
.arena-tile:hover{transform:translateY(-5px); box-shadow:0 6px 15px rgba(0,0,0,0.3);}
.arena-tile h3{margin:10px 0 5px;}
.arena-tile p{margin:3px 0; font-weight:bold;}
.badge{padding:3px 6px; border-radius:6px; font-weight:bold; color:#fff; margin:2px; display:inline-block;}
.badge-pending{background-color:var(--pending-color);}
.badge-inprogress{background-color:var(--inprogress-color);}
.badge-completed{background-color:var(--ok-color);}

.card{background-color:var(--card-bg); border-radius:10px; padding:20px; margin:20px auto; max-width:900px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
input,textarea,select{width:100%; padding:8px; margin:6px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box;}
textarea{resize:vertical;}
button{background-color:var(--secondary-color); color:var(--accent-color); padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:5px;}
button:hover{opacity:0.9;}

table{width:100%; border-collapse:collapse; margin-top:10px;}
th, td{border:1px solid #ccc; padding:6px; text-align:left;}
th{background-color:var(--primary-color); color:var(--secondary-color);}
.status-ok{color:var(--ok-color); font-weight:bold;}
.status-pending{color:var(--pending-color); font-weight:bold;}
.status-inprogress{color:var(--inprogress-color); font-weight:bold;}

.hidden{display:none;}
.modal-card{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999; width:95%; max-width:600px; background:var(--modal-bg); padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.modal-header{display:flex; justify-content:space-between; align-items:center;}
.modal-header h2{margin:0;}
.modal-timeline{max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:10px; margin-top:10px;}
.timeline-entry{border-left:3px solid #ccc; padding-left:10px; margin-bottom:5px;}
.timeline-entry.pending{border-color:var(--pending-color);}
.timeline-entry.inprogress{border-color:var(--inprogress-color);}
.timeline-entry.completed{border-color:var(--ok-color);}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;">
    <img src="nepean-knights-logo.png" alt="Logo" class="logo">
    <img src="knights-banner-updated.png" alt="Banner" class="banner">
  </div>
  <button onclick="logout()">Logout</button>
</header>

<main>
<div class="card">
<h2>Manage Arenas</h2>
<input id="newArenaName" placeholder="Enter Arena Name">
<button onclick="addArena()">âž• Add Arena</button>
</div>

<div class="arena-grid" id="arenaGrid"></div>
<div id="arenaDetailsContainer"></div>

<button onclick="window.location.href='dashboard.html'" style="margin:20px auto; display:block;">
  <i class="fas fa-arrow-left"></i> Back to Dashboard
</button>

<!-- Work Order Modal -->
<div id="WOmodal" class="modal-card hidden">
  <div class="modal-header">
    <h2 id="modalTitle">Work Order Details</h2>
    <button onclick="closeModal()">âœ–</button>
  </div>
  <input id="modalSpokeTo" placeholder="Who you spoke to">
  <input id="modalCityIncident" placeholder="City Incident #">
  <textarea id="modalUpdate" placeholder="Add update..."></textarea>
  <button id="modalAddUpdateBtn">Add Update</button>
  <h3>Update History</h3>
  <div id="modalUpdatesList" class="modal-timeline"></div>
  <label>Status:</label>
  <select id="modalStatusSelect">
    <option>Pending</option>
    <option>In Progress</option>
    <option>Completed</option>
    <option>Closed</option>
  </select>
  <button onclick="saveWOChanges()">Save Changes</button>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAinnWRDZZae0fyeCM--CEhTaRvyOK8hD8",
  authDomain: "nepean-knights-executive-hub.firebaseapp.com",
  projectId: "nepean-knights-executive-hub",
  storageBucket: "nepean-knights-executive-hub.appspot.com"
});
const auth = firebase.auth();
const db = firebase.firestore();
auth.onAuthStateChanged(user => { if(!user) window.location.href="index.html"; });
function logout(){ auth.signOut().then(()=> window.location.href="index.html"); }

let arenas=[];

// Load arenas and tiles
function loadArenas(){
  db.collection('arenas').get().then(snap=>{
    arenas=[]; document.getElementById('arenaGrid').innerHTML='';
    document.getElementById('arenaDetailsContainer').innerHTML='';
    snap.forEach(doc=>{
      const name=doc.id; arenas.push(name);
      db.collection('arenaWorkOrders').where('arena','==',name).get().then(woSnap=>{
        let pending=0, completed=0;
        woSnap.forEach(w=>{ const s=w.data().status; if(s==='Pending') pending++; if(s==='Completed') completed++; });
        const tile=document.createElement('div');
        tile.className='arena-tile';
        tile.innerHTML=`
          <h3>${name}</h3>
          <span class="badge badge-pending">Pending: ${pending}</span>
          <span class="badge badge-completed">Completed: ${completed}</span>
          <div style="margin-top:10px;">
            <button onclick="showArenaDetails('${name}')">View Work Orders</button>
            <button onclick="deleteArena('${name}')">ðŸ—‘ Delete Arena</button>
          </div>
        `;
        document.getElementById('arenaGrid').appendChild(tile);
      });
    });
  });
}

// Add arena
function addArena(){
  const name=document.getElementById('newArenaName').value.trim();
  if(!name) return alert('Enter arena name');
  db.collection('arenas').doc(name).set({createdAt:firebase.firestore.FieldValue.serverTimestamp()})
    .then(()=>{ document.getElementById('newArenaName').value=''; loadArenas(); });
}

// Delete arena
function deleteArena(name){
  if(!confirm(`Delete arena ${name}?`)) return;
  db.collection('arenas').doc(name).delete().then(()=>loadArenas());
  db.collection('arenaWorkOrders').where('arena','==',name).get().then(snap=>snap.forEach(doc=>doc.ref.delete()));
}

// Show arena details
function showArenaDetails(name){
  const container=document.getElementById('arenaDetailsContainer');
  container.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML=`
    <h2>${name} - Work Orders</h2>
    <h3>Create Work Order</h3>
    <input id="WODesc_${name}" placeholder="Description">
    <input type="datetime-local" id="WOTime_${name}">
    <select id="WOStatus_${name}"><option>Pending</option><option>In Progress</option><option>Completed</option></select>
    <button onclick="createWorkOrder('${name}')">Create Work Order</button>
    <h3>Existing Work Orders</h3>
    <table id="WOTable_${name}"><thead><tr><th>WO #</th><th>Time Called</th><th>Description</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
  `;
  container.appendChild(card);
  loadWorkOrders(name);
}

// Create Work Order
function createWorkOrder(arena){
  const desc=document.getElementById('WODesc_'+arena).value.trim();
  const time=document.getElementById('WOTime_'+arena).value;
  const status=document.getElementById('WOStatus_'+arena).value;
  if(!desc||!time) return alert('Fill all fields');
  const now=new Date(), yy=String(now.getFullYear()).slice(2), mm=('0'+(now.getMonth()+1)).slice(-2);
  db.collection('arenaWorkOrders').where('arena','==',arena).get().then(snap=>{
    const woNumber=`${yy}-${mm}-${String(snap.size+1).padStart(3,'0')}`;
    db.collection('arenaWorkOrders').add({
      arena, woNumber, timeCalled: time, description: desc, status, updates:[],
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
      document.getElementById('WODesc_'+arena).value='';
      document.getElementById('WOTime_'+arena).value='';
      showArenaDetails(arena); loadArenas();
    });
  });
}

// Load work orders into table
function loadWorkOrders(arena){
  const tbody=document.getElementById('WOTable_'+arena).querySelector('tbody'); tbody.innerHTML='';
  db.collection('arenaWorkOrders').where('arena','==',arena).get().then(snap=>{
    snap.forEach(doc=>{
      const d=doc.data();
      const statusClass=d.status==='Completed'?'status-ok':d.status==='Pending'?'status-pending':'status-inprogress';
      const row=document.createElement('tr');
      row.innerHTML=`
        <td>${d.woNumber}</td>
        <td>${new Date(d.timeCalled).toLocaleString()}</td>
        <td>${d.description}</td>
        <td class="${statusClass}">${d.status}</td>
        <td><button onclick="deleteWO('${doc.id}','${arena}')">ðŸ—‘ Delete</button></td>
      `;
      row.querySelectorAll('td').forEach(td=>{ td.onclick=(e)=>{ if(e.target.tagName!=='BUTTON') openWorkOrderModal(doc.id); }; });
      tbody.appendChild(row);
    });
  });
}

// Work Order Modal
let currentWO=null;
function openWorkOrderModal(id){
  currentWO=id;
  const modal=document.getElementById('WOmodal'); modal.classList.remove('hidden');
  db.collection('arenaWorkOrders').doc(id).get().then(doc=>{
    if(!doc.exists) return;
    const data=doc.data();
    document.getElementById('modalTitle').innerText=`WO ${data.woNumber} - ${data.arena}`;
    document.getElementById('modalSpokeTo').value=data.spokeTo||'';
    document.getElementById('modalCityIncident').value=data.cityIncident||'';
    document.getElementById('modalStatusSelect').value=data.status||'Pending';
    const updatesDiv=document.getElementById('modalUpdatesList'); updatesDiv.innerHTML='';
    (data.updates||[]).forEach(u=>{
      const div=document.createElement('div'); 
      div.className=`timeline-entry ${u.statusClass||'pending'}`;
      div.innerHTML=`<strong>${u.timestamp?.toDate ? u.timestamp.toDate().toLocaleString() : new Date().toLocaleString()}:</strong> ${u.text}`;
      updatesDiv.appendChild(div);
    });
  });
  document.getElementById('modalAddUpdateBtn').onclick=addWOUpdate;
}

function addWOUpdate(){
  const text=document.getElementById('modalUpdate').value.trim();
  if(!text) return alert('Enter an update');
  const updatesDiv=document.getElementById('modalUpdatesList');
  const update={text, timestamp: firebase.firestore.FieldValue.serverTimestamp(), statusClass:'inprogress'};
  db.collection('arenaWorkOrders').doc(currentWO).update({updates: firebase.firestore.FieldValue.arrayUnion(update)})
  .then(()=>{ document.getElementById('modalUpdate').value=''; const div=document.createElement('div'); div.className='timeline-entry inprogress'; div.innerHTML=`<strong>${new Date().toLocaleString()}:</strong> ${text}`; updatesDiv.appendChild(div); });
}

function saveWOChanges(){
  const status=document.getElementById('modalStatusSelect').value;
  const spokeTo=document.getElementById('modalSpokeTo').value.trim();
  const cityIncident=document.getElementById('modalCityIncident').value.trim();
  db.collection('arenaWorkOrders').doc(currentWO).update({
    status, spokeTo, cityIncident, lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{ alert('Work Order updated'); closeModal(); loadArenas(); arenas.forEach(a=>loadWorkOrders(a)); });
}

function closeModal(){ document.getElementById('WOmodal').classList.add('hidden'); currentWO=null; }

function deleteWO(id,arena){ if(!confirm('Delete this Work Order?')) return; db.collection('arenaWorkOrders').doc(id).delete().then(()=>showArenaDetails(arena)).then(()=>loadArenas()); }

loadArenas();
</script>
</body>
</html>
